{"ast":null,"code":"'use strict';\n\nimport language from './utils/language.js';\nimport mimes from './utils/mimes.js';\nimport data2blob from './utils/data2blob.js';\nimport effectRipple from './utils/effectRipple.js';\nexport default {\n  props: {\n    // 域，上传文件name，触发事件会带上（如果一个页面多个图片上传控件，可以做区分\n    field: {\n      type: String,\n      'default': 'avatar'\n    },\n    // 原名key，类似于id，触发事件会带上（如果一个页面多个图片上传控件，可以做区分\n    ki: {\n      type: String,\n      'default': '0'\n    },\n    // 显示该控件与否\n    modelValue: {\n      type: Boolean,\n      'default': true\n    },\n    // 上传地址\n    url: {\n      type: String,\n      'default': ''\n    },\n    // 其他要上传文件附带的数据，对象格式\n    params: {\n      type: Object,\n      'default': () => null\n    },\n    //Add custom headers\n    headers: {\n      type: Object,\n      'default': () => null\n    },\n    // 剪裁图片的宽\n    width: {\n      type: Number,\n      default: 200\n    },\n    // 剪裁图片的高\n    height: {\n      type: Number,\n      default: 200\n    },\n    // 不显示旋转功能\n    noRotate: {\n      type: Boolean,\n      default: true\n    },\n    // 不预览圆形图片\n    noCircle: {\n      type: Boolean,\n      default: false\n    },\n    // 不预览方形图片\n    noSquare: {\n      type: Boolean,\n      default: false\n    },\n    // 单文件大小限制\n    maxSize: {\n      type: Number,\n      'default': 10240\n    },\n    // 语言类型\n    langType: {\n      type: String,\n      'default': 'zh'\n    },\n    // 语言包\n    langExt: {\n      type: Object,\n      'default': () => null\n    },\n    // 图片上传格式\n    imgFormat: {\n      type: String,\n      'default': 'png'\n    },\n    // 图片背景 jpg情况下生效\n    imgBgc: {\n      type: String,\n      'default': '#fff'\n    },\n    // 是否支持跨域\n    withCredentials: {\n      type: Boolean,\n      'default': false\n    },\n    method: {\n      type: String,\n      'default': 'POST'\n    },\n    initialImgUrl: {\n      type: String,\n      'default': ''\n    },\n    allowImgFormat: {\n      type: Array,\n      'default': () => ['gif', 'jpg', 'png']\n    }\n  },\n  data() {\n    let that = this,\n      {\n        imgFormat,\n        allowImgFormat,\n        langType,\n        langExt,\n        width,\n        height\n      } = that,\n      isSupported = true,\n      tempImgFormat = allowImgFormat.indexOf(imgFormat) === -1 ? 'jpg' : imgFormat,\n      lang = language[langType] ? language[langType] : language['en'],\n      mime = mimes[tempImgFormat];\n    // 规范图片格式\n    // that.imgFormat = tempImgFormat;\n\n    if (langExt) {\n      Object.assign(lang, langExt);\n    }\n    if (typeof FormData != 'function') {\n      isSupported = false;\n    }\n    return {\n      // 图片的mime\n      mime,\n      // 语言包\n      lang,\n      // 浏览器是否支持该控件\n      isSupported,\n      // 浏览器是否支持触屏事件\n      isSupportTouch: document.hasOwnProperty(\"ontouchstart\"),\n      // 步骤\n      step: 1,\n      //1选择文件 2剪裁 3上传\n\n      // 上传状态及进度\n      loading: 0,\n      //0未开始 1正在 2成功 3错误\n      progress: 0,\n      // 是否有错误及错误信息\n      hasError: false,\n      errorMsg: '',\n      // 需求图宽高比\n      ratio: width / height,\n      // 原图地址、生成图片地址\n      sourceImg: null,\n      sourceImgUrl: this.initialImgUrl,\n      createImgUrl: this.initialImgUrl,\n      // 原图片拖动事件初始值\n      sourceImgMouseDown: {\n        on: false,\n        mX: 0,\n        //鼠标按下的坐标\n        mY: 0,\n        x: 0,\n        //scale原图坐标\n        y: 0\n      },\n      // 生成图片预览的容器大小\n      previewContainer: {\n        width: 100,\n        height: 100\n      },\n      // 原图容器宽高\n      sourceImgContainer: {\n        // sic\n        width: 240,\n        height: 184 // 如果生成图比例与此一致会出现bug，先改成特殊的格式吧，哈哈哈\n      },\n\n      // 原图展示属性\n      scale: {\n        zoomAddOn: false,\n        //按钮缩放事件开启\n        zoomSubOn: false,\n        //按钮缩放事件开启\n        range: 1,\n        //最大100\n\n        x: 0,\n        y: 0,\n        width: 0,\n        height: 0,\n        maxWidth: 0,\n        maxHeight: 0,\n        minWidth: 0,\n        //最宽\n        minHeight: 0,\n        naturalWidth: 0,\n        //原宽\n        naturalHeight: 0\n      }\n    };\n  },\n  computed: {\n    // 进度条样式\n    progressStyle() {\n      let {\n        progress\n      } = this;\n      return {\n        width: progress + '%'\n      };\n    },\n    // 原图样式\n    sourceImgStyle() {\n      let {\n          scale,\n          sourceImgMasking\n        } = this,\n        top = scale.y + sourceImgMasking.y + 'px',\n        left = scale.x + sourceImgMasking.x + 'px';\n      return {\n        top,\n        left,\n        width: scale.width + 'px',\n        height: scale.height + 'px' // 兼容 Opera\n      };\n    },\n\n    // 原图蒙版属性\n    sourceImgMasking() {\n      let {\n          width,\n          height,\n          ratio,\n          sourceImgContainer\n        } = this,\n        sic = sourceImgContainer,\n        sicRatio = sic.width / sic.height,\n        // 原图容器宽高比\n        x = 0,\n        y = 0,\n        w = sic.width,\n        h = sic.height,\n        scale = 1;\n      if (ratio < sicRatio) {\n        scale = sic.height / height;\n        w = sic.height * ratio;\n        x = (sic.width - w) / 2;\n      }\n      if (ratio > sicRatio) {\n        scale = sic.width / width;\n        h = sic.width / ratio;\n        y = (sic.height - h) / 2;\n      }\n      return {\n        scale,\n        // 蒙版相对需求宽高的缩放\n        x,\n        y,\n        width: w,\n        height: h\n      };\n    },\n    // 原图遮罩样式\n    sourceImgShadeStyle() {\n      let {\n          sourceImgMasking,\n          sourceImgContainer\n        } = this,\n        sic = sourceImgContainer,\n        sim = sourceImgMasking,\n        w = sim.width == sic.width ? sim.width : (sic.width - sim.width) / 2,\n        h = sim.height == sic.height ? sim.height : (sic.height - sim.height) / 2;\n      return {\n        width: w + 'px',\n        height: h + 'px'\n      };\n    },\n    previewStyle() {\n      let {\n          width,\n          height,\n          ratio,\n          previewContainer\n        } = this,\n        pc = previewContainer,\n        w = pc.width,\n        h = pc.height,\n        pcRatio = w / h;\n      if (ratio < pcRatio) {\n        w = pc.height * ratio;\n      }\n      if (ratio > pcRatio) {\n        h = pc.width / ratio;\n      }\n      return {\n        width: w + 'px',\n        height: h + 'px'\n      };\n    }\n  },\n  watch: {\n    modelValue(newValue) {\n      if (newValue && this.loading != 1) {\n        this.reset();\n      }\n    }\n  },\n  created() {\n    // 绑定按键esc隐藏此插件事件\n    document.addEventListener('keyup', this.handleEscClose);\n  },\n  beforeUnmount() {\n    document.removeEventListener('keyup', this.handleEscClose);\n  },\n  mounted() {\n    if (this.sourceImgUrl) {\n      this.startCrop();\n    }\n  },\n  methods: {\n    handleEscClose(e) {\n      if (this.modelValue && (e.key == 'Escape' || e.keyCode == 27)) {\n        this.off();\n      }\n    },\n    // 点击波纹效果\n    ripple(e) {\n      effectRipple(e);\n    },\n    // 关闭控件\n    off() {\n      setTimeout(() => {\n        this.$emit('update:modelValue', false);\n        if (this.step == 3 && this.loading == 2) {\n          this.setStep(1);\n        }\n      }, 200);\n    },\n    // 设置步骤\n    setStep(no) {\n      // 延时是为了显示动画效果呢，哈哈哈\n      setTimeout(() => {\n        this.step = no;\n      }, 200);\n    },\n    /* 图片选择区域函数绑定\n     ---------------------------------------------------------------*/\n    preventDefault(e) {\n      e.preventDefault();\n      return false;\n    },\n    handleClick(e) {\n      if (this.loading !== 1) {\n        if (e.target !== this.$refs.fileinput) {\n          e.preventDefault();\n          if (document.activeElement !== this.$refs) {\n            this.$refs.fileinput.click();\n          }\n        }\n      }\n    },\n    handleChange(e) {\n      e.preventDefault();\n      if (this.loading !== 1) {\n        let files = e.target.files || e.dataTransfer.files;\n        this.reset();\n        if (this.checkFile(files[0])) {\n          this.setSourceImg(files[0]);\n        }\n      }\n    },\n    /* ---------------------------------------------------------------*/\n\n    // 检测选择的文件是否合适\n    checkFile(file) {\n      let that = this,\n        {\n          lang,\n          maxSize\n        } = that;\n      // 仅限图片\n      if (file.type.indexOf('image') === -1) {\n        that.hasError = true;\n        that.errorMsg = lang.error.onlyImg;\n        return false;\n      }\n\n      // 超出大小\n      if (file.size / 1024 > maxSize) {\n        that.hasError = true;\n        that.errorMsg = lang.error.outOfSize + maxSize + 'kb';\n        return false;\n      }\n      return true;\n    },\n    // 重置控件\n    reset() {\n      let that = this;\n      that.loading = 0;\n      that.hasError = false;\n      that.errorMsg = '';\n      that.progress = 0;\n    },\n    // 设置图片源\n    setSourceImg(file) {\n      this.$emit('src-file-set', file.name, file.type, file.size);\n      let that = this,\n        fr = new FileReader();\n      fr.onload = function (e) {\n        that.sourceImgUrl = fr.result;\n        that.startCrop();\n      };\n      fr.readAsDataURL(file);\n    },\n    // 剪裁前准备工作\n    startCrop() {\n      let that = this,\n        {\n          width,\n          height,\n          ratio,\n          scale,\n          sourceImgUrl,\n          sourceImgMasking,\n          lang\n        } = that,\n        sim = sourceImgMasking,\n        img = new Image();\n      img.src = sourceImgUrl;\n      img.onload = function () {\n        let nWidth = img.naturalWidth,\n          nHeight = img.naturalHeight,\n          nRatio = nWidth / nHeight,\n          w = sim.width,\n          h = sim.height,\n          x = 0,\n          y = 0;\n        // 图片像素不达标\n        if (nWidth < width || nHeight < height) {\n          that.hasError = true;\n          that.errorMsg = lang.error.lowestPx + width + '*' + height;\n          return false;\n        }\n        if (ratio > nRatio) {\n          h = w / nRatio;\n          y = (sim.height - h) / 2;\n        }\n        if (ratio < nRatio) {\n          w = h * nRatio;\n          x = (sim.width - w) / 2;\n        }\n        scale.range = 0;\n        scale.x = x;\n        scale.y = y;\n        scale.width = w;\n        scale.height = h;\n        scale.minWidth = w;\n        scale.minHeight = h;\n        scale.maxWidth = nWidth * sim.scale;\n        scale.maxHeight = nHeight * sim.scale;\n        scale.naturalWidth = nWidth;\n        scale.naturalHeight = nHeight;\n        that.sourceImg = img;\n        that.createImg();\n        that.setStep(2);\n      };\n    },\n    // 鼠标按下图片准备移动\n    imgStartMove(e) {\n      e.preventDefault();\n      // 支持触摸事件，则鼠标事件无效\n      if (this.isSupportTouch && !e.targetTouches) {\n        return false;\n      }\n      let et = e.targetTouches ? e.targetTouches[0] : e,\n        {\n          sourceImgMouseDown,\n          scale\n        } = this,\n        simd = sourceImgMouseDown;\n      simd.mX = et.screenX;\n      simd.mY = et.screenY;\n      simd.x = scale.x;\n      simd.y = scale.y;\n      simd.on = true;\n    },\n    // 鼠标按下状态下移动，图片移动\n    imgMove(e) {\n      e.preventDefault();\n      // 支持触摸事件，则鼠标事件无效\n      if (this.isSupportTouch && !e.targetTouches) {\n        return false;\n      }\n      let et = e.targetTouches ? e.targetTouches[0] : e,\n        {\n          sourceImgMouseDown: {\n            on,\n            mX,\n            mY,\n            x,\n            y\n          },\n          scale,\n          sourceImgMasking\n        } = this,\n        sim = sourceImgMasking,\n        nX = et.screenX,\n        nY = et.screenY,\n        dX = nX - mX,\n        dY = nY - mY,\n        rX = x + dX,\n        rY = y + dY;\n      if (!on) return;\n      if (rX > 0) {\n        rX = 0;\n      }\n      if (rY > 0) {\n        rY = 0;\n      }\n      if (rX < sim.width - scale.width) {\n        rX = sim.width - scale.width;\n      }\n      if (rY < sim.height - scale.height) {\n        rY = sim.height - scale.height;\n      }\n      scale.x = rX;\n      scale.y = rY;\n    },\n    // 顺时针旋转图片\n    rotateImg(e) {\n      let {\n          sourceImg,\n          scale: {\n            naturalWidth,\n            naturalHeight\n          }\n        } = this,\n        width = naturalHeight,\n        height = naturalWidth,\n        canvas = this.$refs.canvas,\n        ctx = canvas.getContext('2d');\n      canvas.width = width;\n      canvas.height = height;\n      ctx.clearRect(0, 0, width, height);\n      ctx.fillStyle = 'rgba(0,0,0,0)';\n      ctx.fillRect(0, 0, width, height);\n      ctx.translate(width, 0);\n      ctx.rotate(Math.PI * 90 / 180);\n      ctx.drawImage(sourceImg, 0, 0, naturalWidth, naturalHeight);\n      let imgUrl = canvas.toDataURL(mimes['png']);\n      this.sourceImgUrl = imgUrl;\n      this.startCrop();\n    },\n    handleMouseWheel(e) {\n      e = e || window.event;\n      let {\n        scale\n      } = this;\n      if (e.wheelDelta) {\n        //判断浏览器IE，谷歌滑轮事件\n        if (e.wheelDelta > 0) {\n          //当滑轮向上滚动时\n          this.zoomImg(scale.range >= 100 ? 100 : ++scale.range);\n        }\n        if (e.wheelDelta < 0) {\n          this.zoomImg(scale.range <= 0 ? 0 : --scale.range);\n        }\n      } else if (e.detail) {\n        //Firefox滑轮事件\n        if (e.detail > 0) {\n          //当滑轮向上滚动时\n          this.zoomImg(scale.range >= 100 ? 100 : ++scale.range);\n        }\n        if (e.detail < 0) {\n          this.zoomImg(scale.range <= 0 ? 0 : --scale.range);\n        }\n      }\n    },\n    // 按钮按下开始放大\n    startZoomAdd(e) {\n      let that = this,\n        {\n          scale\n        } = that;\n      scale.zoomAddOn = true;\n      function zoom() {\n        if (scale.zoomAddOn) {\n          let range = scale.range >= 100 ? 100 : ++scale.range;\n          that.zoomImg(range);\n          setTimeout(function () {\n            zoom();\n          }, 60);\n        }\n      }\n      zoom();\n    },\n    // 按钮松开或移开取消放大\n    endZoomAdd(e) {\n      this.scale.zoomAddOn = false;\n    },\n    // 按钮按下开始缩小\n    startZoomSub(e) {\n      let that = this,\n        {\n          scale\n        } = that;\n      scale.zoomSubOn = true;\n      function zoom() {\n        if (scale.zoomSubOn) {\n          let range = scale.range <= 0 ? 0 : --scale.range;\n          that.zoomImg(range);\n          setTimeout(function () {\n            zoom();\n          }, 60);\n        }\n      }\n      zoom();\n    },\n    // 按钮松开或移开取消缩小\n    endZoomSub(e) {\n      let {\n        scale\n      } = this;\n      scale.zoomSubOn = false;\n    },\n    zoomChange(e) {\n      this.zoomImg(e.target.value);\n    },\n    // 缩放原图\n    zoomImg(newRange) {\n      let that = this,\n        {\n          sourceImgMasking,\n          sourceImgMouseDown,\n          scale\n        } = this,\n        {\n          maxWidth,\n          maxHeight,\n          minWidth,\n          minHeight,\n          width,\n          height,\n          x,\n          y,\n          range\n        } = scale,\n        sim = sourceImgMasking,\n        // 蒙版宽高\n        sWidth = sim.width,\n        sHeight = sim.height,\n        // 新宽高\n        nWidth = minWidth + (maxWidth - minWidth) * newRange / 100,\n        nHeight = minHeight + (maxHeight - minHeight) * newRange / 100,\n        // 新坐标（根据蒙版中心点缩放）\n        nX = sWidth / 2 - nWidth / width * (sWidth / 2 - x),\n        nY = sHeight / 2 - nHeight / height * (sHeight / 2 - y);\n\n      // 判断新坐标是否超过蒙版限制\n      if (nX > 0) {\n        nX = 0;\n      }\n      if (nY > 0) {\n        nY = 0;\n      }\n      if (nX < sWidth - nWidth) {\n        nX = sWidth - nWidth;\n      }\n      if (nY < sHeight - nHeight) {\n        nY = sHeight - nHeight;\n      }\n\n      // 赋值处理\n      scale.x = nX;\n      scale.y = nY;\n      scale.width = nWidth;\n      scale.height = nHeight;\n      scale.range = newRange;\n      setTimeout(function () {\n        if (scale.range == newRange) {\n          that.createImg();\n        }\n      }, 300);\n    },\n    // 生成需求图片\n    createImg(e) {\n      let that = this,\n        {\n          imgFormat,\n          imgBgc,\n          mime,\n          sourceImg,\n          scale: {\n            x,\n            y,\n            width,\n            height\n          },\n          sourceImgMasking: {\n            scale\n          }\n        } = that,\n        canvas = that.$refs.canvas,\n        ctx = canvas.getContext('2d');\n      if (e) {\n        // 取消鼠标按下移动状态\n        that.sourceImgMouseDown.on = false;\n      }\n      canvas.width = that.width;\n      canvas.height = that.height;\n      ctx.clearRect(0, 0, that.width, that.height);\n      if (imgFormat == 'png') {\n        ctx.fillStyle = 'rgba(0,0,0,0)';\n      } else {\n        // 如果jpg 为透明区域设置背景，默认白色\n        ctx.fillStyle = imgBgc;\n      }\n      ctx.fillRect(0, 0, that.width, that.height);\n      ctx.drawImage(sourceImg, x / scale, y / scale, width / scale, height / scale);\n      that.createImgUrl = canvas.toDataURL(mime);\n    },\n    prepareUpload() {\n      let {\n        url,\n        createImgUrl,\n        field,\n        ki\n      } = this;\n      this.$emit('crop-success', createImgUrl, field, ki);\n      if (typeof url == 'string' && url) {\n        this.upload();\n      } else {\n        this.off();\n      }\n    },\n    // 上传图片\n    upload() {\n      let that = this,\n        {\n          lang,\n          imgFormat,\n          mime,\n          url,\n          params,\n          headers,\n          field,\n          ki,\n          createImgUrl,\n          withCredentials,\n          method\n        } = this,\n        fmData = new FormData();\n\n      // 添加其他参数\n      if (typeof params == 'object' && params) {\n        Object.keys(params).forEach(k => {\n          fmData.append(k, params[k]);\n        });\n      }\n\n      // 将field的添加放到表单域的最后，以支持阿里云OSS的表单上传\n      fmData.append(field, data2blob(createImgUrl, mime), field + '.' + imgFormat);\n\n      // 监听进度回调\n      const uploadProgress = function (event) {\n        if (event.lengthComputable) {\n          that.progress = 100 * Math.round(event.loaded) / event.total;\n        }\n      };\n\n      // 上传文件\n      that.reset();\n      that.loading = 1;\n      that.setStep(3);\n      new Promise(function (resolve, reject) {\n        let client = new XMLHttpRequest();\n        client.open(method, url, true);\n        client.withCredentials = withCredentials;\n        client.onreadystatechange = function () {\n          if (this.readyState !== 4) {\n            return;\n          }\n          if (this.status === 200 || this.status === 201 || this.staus === 202) {\n            resolve(JSON.parse(this.responseText));\n          } else {\n            reject(this.status);\n          }\n        };\n        client.upload.addEventListener(\"progress\", uploadProgress, false); //监听进度\n        // 设置header\n        if (typeof headers == 'object' && headers) {\n          Object.keys(headers).forEach(k => {\n            client.setRequestHeader(k, headers[k]);\n          });\n        }\n        client.send(fmData);\n      }).then(\n      // 上传成功\n      function (resData) {\n        if (that.modelValue) {\n          that.loading = 2;\n          that.$emit('crop-upload-success', resData, field, ki);\n        }\n      },\n      // 上传失败\n      function (sts) {\n        if (that.modelValue) {\n          that.loading = 3;\n          that.hasError = true;\n          that.errorMsg = lang.fail;\n          that.$emit('crop-upload-fail', sts, field, ki);\n        }\n      });\n    }\n  }\n};","map":{"version":3,"mappings":"AAwGA,YAAY;;AACZ,OAAOA,QAAO,MAAO,qBAAqB;AAC1C,OAAOC,KAAI,MAAO,kBAAkB;AACpC,OAAOC,SAAQ,MAAO,sBAAsB;AAC5C,OAAOC,YAAW,MAAO,yBAAyB;AAElD,eAAe;EACdC,KAAK,EAAE;IACN;IACAC,KAAK,EAAE;MACNC,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAC,EAAE,EAAE;MACHF,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAE,UAAU,EAAE;MACXH,IAAI,EAAEI,OAAO;MACb,SAAS,EAAE;IACZ,CAAC;IACD;IACAC,GAAG,EAAE;MACJL,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAK,MAAM,EAAE;MACPN,IAAI,EAAEO,MAAM;MACZ,SAAS,EAAEC,MAAI;IAChB,CAAC;IACD;IACAC,OAAO,EAAE;MACRT,IAAI,EAAEO,MAAM;MACZ,SAAS,EAAEC,MAAI;IAChB,CAAC;IACD;IACAE,KAAK,EAAE;MACNV,IAAI,EAAEW,MAAM;MACZH,OAAO,EAAE;IACV,CAAC;IACD;IACAI,MAAM,EAAE;MACPZ,IAAI,EAAEW,MAAM;MACZH,OAAO,EAAE;IACV,CAAC;IACD;IACAK,QAAQ,EAAE;MACTb,IAAI,EAAEI,OAAO;MACbI,OAAO,EAAE;IACV,CAAC;IACD;IACAM,QAAQ,EAAE;MACTd,IAAI,EAAEI,OAAO;MACbI,OAAO,EAAE;IACV,CAAC;IACD;IACAO,QAAQ,EAAE;MACTf,IAAI,EAAEI,OAAO;MACbI,OAAO,EAAE;IACV,CAAC;IACD;IACAQ,OAAO,EAAE;MACRhB,IAAI,EAAEW,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAM,QAAQ,EAAE;MACTjB,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAiB,OAAO,EAAE;MACRlB,IAAI,EAAEO,MAAM;MACZ,SAAS,EAAEC,MAAI;IAChB,CAAC;IACD;IACAW,SAAS,EAAE;MACVnB,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAmB,MAAM,EAAE;MACPpB,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACD;IACAoB,eAAe,EAAE;MAChBrB,IAAI,EAAEI,OAAO;MACb,SAAS,EAAE;IACZ,CAAC;IACDkB,MAAM,EAAE;MACPtB,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACZ,CAAC;IACDsB,aAAa,EAAE;MACdvB,IAAI,EAAEC,MAAM;MACZ,SAAS,EAAE;IACT,CAAC;IACDuB,cAAc,EAAE;MACfxB,IAAI,EAAEyB,KAAK;MACX,SAAS,EAAEjB,MAAI,CACd,KAAK,EACT,KAAK,EACL,KAAI;IAEF;EACJ,CAAC;EAEDkB,IAAIA,GAAG;IACN,IAAIC,IAAG,GAAI,IAAI;MACd;QACCR,SAAS;QACTK,cAAc;QACdP,QAAQ;QACRC,OAAO;QACPR,KAAK;QACLE;MACD,IAAIe,IAAI;MACRC,WAAU,GAAI,IAAI;MAClBC,aAAY,GAAIL,cAAc,CAACM,OAAO,CAACX,SAAS,MAAM,CAAC,IAAI,KAAI,GAAIA,SAAS;MAC5EY,IAAG,GAAIrC,QAAQ,CAACuB,QAAQ,IAAIvB,QAAQ,CAACuB,QAAQ,IAAIvB,QAAQ,CAAC,IAAI,CAAC;MAC/DsC,IAAG,GAAIrC,KAAK,CAACkC,aAAa,CAAC;IAC5B;IACA;;IAEA,IAAIX,OAAO,EAAE;MACZX,MAAM,CAAC0B,MAAM,CAACF,IAAI,EAAEb,OAAO,CAAC;IAC7B;IACA,IAAI,OAAOgB,QAAO,IAAK,UAAU,EAAE;MAClCN,WAAU,GAAI,KAAK;IACpB;IACA,OAAO;MACN;MACAI,IAAI;MAEJ;MACAD,IAAI;MAEJ;MACAH,WAAW;MACX;MACAO,cAAc,EAAEC,QAAQ,CAACC,cAAc,CAAC,cAAc,CAAC;MAEvD;MACAC,IAAI,EAAE,CAAC;MAAE;;MAET;MACAC,OAAO,EAAE,CAAC;MAAE;MACZC,QAAQ,EAAE,CAAC;MAEX;MACAC,QAAQ,EAAE,KAAK;MACfC,QAAQ,EAAE,EAAE;MAEZ;MACAC,KAAK,EAAEjC,KAAI,GAAIE,MAAM;MAErB;MACAgC,SAAS,EAAE,IAAI;MACfC,YAAY,EAAE,IAAI,CAACtB,aAAa;MAChCuB,YAAY,EAAE,IAAI,CAACvB,aAAa;MAEhC;MACAwB,kBAAkB,EAAE;QACnBC,EAAE,EAAE,KAAK;QACTC,EAAE,EAAE,CAAC;QAAE;QACPC,EAAE,EAAE,CAAC;QACLC,CAAC,EAAE,CAAC;QAAE;QACNC,CAAC,EAAE;MACJ,CAAC;MAED;MACAC,gBAAgB,EAAE;QACjB3C,KAAK,EAAE,GAAG;QACVE,MAAM,EAAE;MACT,CAAC;MAED;MACA0C,kBAAkB,EAAE;QAAE;QACrB5C,KAAK,EAAE,GAAG;QACVE,MAAM,EAAE,GAAE,CAAE;MACb,CAAC;;MAED;MACA2C,KAAK,EAAE;QACNC,SAAS,EAAE,KAAK;QAAE;QAClBC,SAAS,EAAE,KAAK;QAAE;QAClBC,KAAK,EAAE,CAAC;QAAE;;QAEVP,CAAC,EAAE,CAAC;QACJC,CAAC,EAAE,CAAC;QACJ1C,KAAK,EAAE,CAAC;QACRE,MAAM,EAAE,CAAC;QACT+C,QAAQ,EAAE,CAAC;QACXC,SAAS,EAAE,CAAC;QACZC,QAAQ,EAAE,CAAC;QAAE;QACbC,SAAS,EAAE,CAAC;QACZC,YAAY,EAAE,CAAC;QAAE;QACjBC,aAAa,EAAE;MAChB;IACD;EACD,CAAC;EAEDC,QAAQ,EAAE;IACT;IACAC,aAAaA,GAAG;MACf,IAAI;QACH1B;MACD,IAAI,IAAI;MACR,OAAO;QACN9B,KAAK,EAAE8B,QAAO,GAAI;MACnB;IACD,CAAC;IACD;IACA2B,cAAcA,GAAG;MAChB,IAAI;UACFZ,KAAK;UACLa;QACD,IAAI,IAAI;QACRC,GAAE,GAAId,KAAK,CAACH,IAAIgB,gBAAgB,CAAChB,IAAI,IAAI;QACzCkB,IAAG,GAAIf,KAAK,CAACJ,IAAIiB,gBAAgB,CAACjB,IAAI,IAAI;MAC3C,OAAO;QACNkB,GAAG;QACHC,IAAI;QACJ5D,KAAK,EAAE6C,KAAK,CAAC7C,KAAI,GAAI,IAAI;QACzBE,MAAM,EAAE2C,KAAK,CAAC3C,MAAK,GAAI,IAAI,CAAC;MAC7B;IACD,CAAC;;IACD;IACAwD,gBAAgBA,GAAG;MAClB,IAAI;UACF1D,KAAK;UACLE,MAAM;UACN+B,KAAK;UACLW;QACD,IAAI,IAAI;QACRiB,GAAE,GAAIjB,kBAAkB;QACxBkB,QAAO,GAAID,GAAG,CAAC7D,KAAI,GAAI6D,GAAG,CAAC3D,MAAM;QAAE;QACnCuC,IAAI,CAAC;QACLC,IAAI,CAAC;QACLqB,IAAIF,GAAG,CAAC7D,KAAK;QACbgE,IAAIH,GAAG,CAAC3D,MAAM;QACd2C,KAAI,GAAI,CAAC;MACV,IAAIZ,KAAI,GAAI6B,QAAQ,EAAE;QACrBjB,KAAI,GAAIgB,GAAG,CAAC3D,MAAK,GAAIA,MAAM;QAC3B6D,IAAIF,GAAG,CAAC3D,MAAK,GAAI+B,KAAK;QACtBQ,IAAI,CAACoB,GAAG,CAAC7D,KAAI,GAAI+D,CAAC,IAAI,CAAC;MACxB;MACA,IAAI9B,KAAI,GAAI6B,QAAQ,EAAE;QACrBjB,KAAI,GAAIgB,GAAG,CAAC7D,KAAI,GAAIA,KAAK;QACzBgE,IAAIH,GAAG,CAAC7D,KAAI,GAAIiC,KAAK;QACrBS,IAAI,CAACmB,GAAG,CAAC3D,MAAK,GAAI8D,CAAC,IAAI,CAAC;MACzB;MACA,OAAO;QACNnB,KAAK;QAAE;QACPJ,CAAC;QACDC,CAAC;QACD1C,KAAK,EAAE+D,CAAC;QACR7D,MAAM,EAAE8D;MACT,CAAC;IACF,CAAC;IACD;IACAC,mBAAmBA,GAAG;MACrB,IAAI;UACFP,gBAAgB;UAChBd;QACD,IAAI,IAAI;QACRiB,GAAE,GAAIjB,kBAAkB;QACxBsB,GAAE,GAAIR,gBAAgB;QACtBK,IAAIG,GAAG,CAAClE,KAAI,IAAK6D,GAAG,CAAC7D,KAAI,GAAIkE,GAAG,CAAClE,KAAI,GAAI,CAAC6D,GAAG,CAAC7D,KAAI,GAAIkE,GAAG,CAAClE,KAAK,IAAI,CAAC;QACpEgE,IAAIE,GAAG,CAAChE,MAAK,IAAK2D,GAAG,CAAC3D,MAAK,GAAIgE,GAAG,CAAChE,MAAK,GAAI,CAAC2D,GAAG,CAAC3D,MAAK,GAAIgE,GAAG,CAAChE,MAAM,IAAI,CAAC;MAC1E,OAAO;QACNF,KAAK,EAAE+D,IAAI,IAAI;QACf7D,MAAM,EAAE8D,IAAI;MACb,CAAC;IACF,CAAC;IACDG,YAAYA,GAAG;MACd,IAAI;UACFnE,KAAK;UACLE,MAAM;UACN+B,KAAK;UACLU;QACD,IAAI,IAAI;QACRyB,EAAC,GAAIzB,gBAAgB;QACrBoB,IAAIK,EAAE,CAACpE,KAAK;QACZgE,IAAII,EAAE,CAAClE,MAAM;QACbmE,OAAM,GAAIN,IAAIC,CAAC;MAChB,IAAI/B,KAAI,GAAIoC,OAAO,EAAE;QACpBN,IAAIK,EAAE,CAAClE,MAAK,GAAI+B,KAAK;MACtB;MACA,IAAIA,KAAI,GAAIoC,OAAO,EAAE;QACpBL,IAAII,EAAE,CAACpE,KAAI,GAAIiC,KAAK;MACrB;MACA,OAAO;QACNjC,KAAK,EAAE+D,IAAI,IAAI;QACf7D,MAAM,EAAE8D,IAAI;MACb,CAAC;IACF;EACD,CAAC;EAEDM,KAAK,EAAE;IACN7E,UAAUA,CAAC8E,QAAQ,EAAE;MACpB,IAAIA,QAAO,IAAK,IAAI,CAAC1C,OAAM,IAAK,CAAC,EAAE;QAClC,IAAI,CAAC2C,KAAK,CAAC,CAAC;MACb;IACD;EACD,CAAC;EAEDC,OAAOA,GAAE;IACR;IACA/C,QAAQ,CAACgD,gBAAgB,CAAC,OAAO,EAAE,IAAI,CAACC,cAAe;EACxD,CAAC;EAEDC,aAAaA,GAAE;IACdlD,QAAQ,CAACmD,mBAAmB,CAAC,OAAO,EAAE,IAAI,CAACF,cAAe;EAC3D,CAAC;EAEDG,OAAOA,GAAG;IACT,IAAI,IAAI,CAAC3C,YAAY,EAAE;MACtB,IAAI,CAAC4C,SAAS,CAAC,CAAC;IACjB;EACD,CAAC;EAEDC,OAAO,EAAE;IACRL,cAAcA,CAACM,CAAC,EAAC;MAChB,IAAG,IAAI,CAACxF,UAAS,KAAMwF,CAAC,CAACC,GAAE,IAAK,QAAO,IAAKD,CAAC,CAACE,OAAM,IAAK,EAAE,CAAC,EAAC;QAC5D,IAAI,CAACC,GAAG,CAAC,CAAC;MACX;IACD,CAAC;IACD;IACAC,MAAMA,CAACJ,CAAC,EAAE;MACT9F,YAAY,CAAC8F,CAAC,CAAC;IAChB,CAAC;IACD;IACAG,GAAGA,GAAG;MACLE,UAAU,CAAC,MAAK;QACf,IAAI,CAACC,KAAK,CAAC,mBAAmB,EAAE,KAAK,CAAC;QACtC,IAAG,IAAI,CAAC3D,IAAG,IAAK,KAAK,IAAI,CAACC,OAAM,IAAK,CAAC,EAAC;UACtC,IAAI,CAAC2D,OAAO,CAAC,CAAC,CAAC;QAChB;MACD,CAAC,EAAE,GAAG,CAAC;IACR,CAAC;IACD;IACAA,OAAOA,CAACC,EAAE,EAAE;MACX;MACAH,UAAU,CAAC,MAAK;QACf,IAAI,CAAC1D,IAAG,GAAI6D,EAAE;MACf,CAAC,EAAE,GAAG,CAAC;IACR,CAAC;IAED;;IAEAC,cAAcA,CAACT,CAAC,EAAE;MACjBA,CAAC,CAACS,cAAc,CAAC,CAAC;MAClB,OAAO,KAAK;IACb,CAAC;IACDC,WAAWA,CAACV,CAAC,EAAE;MACd,IAAI,IAAI,CAACpD,OAAM,KAAM,CAAC,EAAE;QACvB,IAAIoD,CAAC,CAACW,MAAK,KAAM,IAAI,CAACC,KAAK,CAACC,SAAS,EAAE;UACtCb,CAAC,CAACS,cAAc,CAAC,CAAC;UAClB,IAAIhE,QAAQ,CAACqE,aAAY,KAAM,IAAI,CAACF,KAAK,EAAE;YAC1C,IAAI,CAACA,KAAK,CAACC,SAAS,CAACE,KAAK,CAAC,CAAC;UAC7B;QACD;MACD;IACD,CAAC;IACDC,YAAYA,CAAChB,CAAC,EAAE;MACfA,CAAC,CAACS,cAAc,CAAC,CAAC;MAClB,IAAI,IAAI,CAAC7D,OAAM,KAAM,CAAC,EAAE;QACvB,IAAIqE,KAAI,GAAIjB,CAAC,CAACW,MAAM,CAACM,KAAI,IAAKjB,CAAC,CAACkB,YAAY,CAACD,KAAK;QAClD,IAAI,CAAC1B,KAAK,CAAC,CAAC;QACZ,IAAI,IAAI,CAAC4B,SAAS,CAACF,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE;UAC7B,IAAI,CAACG,YAAY,CAACH,KAAK,CAAC,CAAC,CAAC,CAAC;QAC5B;MACD;IACD,CAAC;IACD;;IAEA;IACAE,SAASA,CAACE,IAAI,EAAE;MACf,IAAIrF,IAAG,GAAI,IAAI;QACd;UACCI,IAAI;UACJf;QACD,IAAIW,IAAI;MACT;MACA,IAAIqF,IAAI,CAAChH,IAAI,CAAC8B,OAAO,CAAC,OAAO,MAAM,CAAC,CAAC,EAAE;QACtCH,IAAI,CAACc,QAAO,GAAI,IAAI;QACpBd,IAAI,CAACe,QAAO,GAAIX,IAAI,CAACkF,KAAK,CAACC,OAAO;QAClC,OAAO,KAAK;MACb;;MAEA;MACA,IAAIF,IAAI,CAACG,IAAG,GAAI,IAAG,GAAInG,OAAO,EAAE;QAC/BW,IAAI,CAACc,QAAO,GAAI,IAAI;QACpBd,IAAI,CAACe,QAAO,GAAIX,IAAI,CAACkF,KAAK,CAACG,SAAQ,GAAIpG,OAAM,GAAI,IAAI;QACrD,OAAO,KAAK;MACb;MACA,OAAO,IAAI;IACZ,CAAC;IACD;IACAkE,KAAKA,GAAG;MACP,IAAIvD,IAAG,GAAI,IAAI;MACfA,IAAI,CAACY,OAAM,GAAI,CAAC;MAChBZ,IAAI,CAACc,QAAO,GAAI,KAAK;MACrBd,IAAI,CAACe,QAAO,GAAI,EAAE;MAClBf,IAAI,CAACa,QAAO,GAAI,CAAC;IAClB,CAAC;IACD;IACAuE,YAAYA,CAACC,IAAI,EAAE;MAClB,IAAI,CAACf,KAAK,CAAC,cAAc,EAAEe,IAAI,CAACK,IAAI,EAAEL,IAAI,CAAChH,IAAI,EAAEgH,IAAI,CAACG,IAAI,CAAC;MAC3D,IAAIxF,IAAG,GAAI,IAAI;QACd2F,EAAC,GAAI,IAAIC,UAAU,CAAC,CAAC;MACtBD,EAAE,CAACE,MAAK,GAAI,UAAS7B,CAAC,EAAE;QACvBhE,IAAI,CAACkB,YAAW,GAAIyE,EAAE,CAACG,MAAM;QAC7B9F,IAAI,CAAC8D,SAAS,CAAC,CAAC;MACjB;MACA6B,EAAE,CAACI,aAAa,CAACV,IAAI,CAAC;IACvB,CAAC;IACD;IACAvB,SAASA,GAAG;MACX,IAAI9D,IAAG,GAAI,IAAI;QACd;UACCjB,KAAK;UACLE,MAAM;UACN+B,KAAK;UACLY,KAAK;UACLV,YAAY;UACZuB,gBAAgB;UAChBrC;QACD,IAAIJ,IAAI;QACRiD,GAAE,GAAIR,gBAAgB;QACtBuD,GAAE,GAAI,IAAIC,KAAK,CAAC,CAAC;MAClBD,GAAG,CAACE,GAAE,GAAIhF,YAAY;MACtB8E,GAAG,CAACH,MAAK,GAAI,YAAW;QACvB,IAAIM,MAAK,GAAIH,GAAG,CAAC5D,YAAY;UAC5BgE,OAAM,GAAIJ,GAAG,CAAC3D,aAAa;UAC3BgE,MAAK,GAAIF,MAAK,GAAIC,OAAO;UACzBtD,IAAIG,GAAG,CAAClE,KAAK;UACbgE,IAAIE,GAAG,CAAChE,MAAM;UACduC,IAAI,CAAC;UACLC,IAAI,CAAC;QACN;QACA,IAAI0E,MAAK,GAAIpH,KAAI,IAAKqH,OAAM,GAAInH,MAAM,EAAE;UACvCe,IAAI,CAACc,QAAO,GAAI,IAAI;UACpBd,IAAI,CAACe,QAAO,GAAIX,IAAI,CAACkF,KAAK,CAACgB,QAAO,GAAIvH,KAAI,GAAI,GAAE,GAAIE,MAAM;UAC1D,OAAO,KAAK;QACb;QACA,IAAI+B,KAAI,GAAIqF,MAAM,EAAE;UACnBtD,IAAID,IAAIuD,MAAM;UACd5E,IAAI,CAACwB,GAAG,CAAChE,MAAK,GAAI8D,CAAC,IAAI,CAAC;QACzB;QACA,IAAI/B,KAAI,GAAIqF,MAAM,EAAE;UACnBvD,IAAIC,IAAIsD,MAAM;UACd7E,IAAI,CAACyB,GAAG,CAAClE,KAAI,GAAI+D,CAAC,IAAI,CAAC;QACxB;QACAlB,KAAK,CAACG,KAAI,GAAI,CAAC;QACfH,KAAK,CAACJ,IAAIA,CAAC;QACXI,KAAK,CAACH,IAAIA,CAAC;QACXG,KAAK,CAAC7C,KAAI,GAAI+D,CAAC;QACflB,KAAK,CAAC3C,MAAK,GAAI8D,CAAC;QAChBnB,KAAK,CAACM,QAAO,GAAIY,CAAC;QAClBlB,KAAK,CAACO,SAAQ,GAAIY,CAAC;QACnBnB,KAAK,CAACI,QAAO,GAAImE,MAAK,GAAIlD,GAAG,CAACrB,KAAK;QACnCA,KAAK,CAACK,SAAQ,GAAImE,OAAM,GAAInD,GAAG,CAACrB,KAAK;QACrCA,KAAK,CAACQ,YAAW,GAAI+D,MAAM;QAC3BvE,KAAK,CAACS,aAAY,GAAI+D,OAAO;QAC7BpG,IAAI,CAACiB,SAAQ,GAAI+E,GAAG;QACpBhG,IAAI,CAACuG,SAAS,CAAC,CAAC;QAChBvG,IAAI,CAACuE,OAAO,CAAC,CAAC,CAAC;MAChB,CAAC;IACF,CAAC;IACD;IACAiC,YAAYA,CAACxC,CAAC,EAAE;MACfA,CAAC,CAACS,cAAc,CAAC,CAAC;MAClB;MACA,IAAG,IAAI,CAACjE,cAAa,IAAK,CAACwD,CAAC,CAACyC,aAAa,EAAC;QAC1C,OAAO,KAAK;MACb;MACA,IAAIC,EAAC,GAAI1C,CAAC,CAACyC,aAAY,GAAIzC,CAAC,CAACyC,aAAa,CAAC,CAAC,IAAIzC,CAAC;QAChD;UACC5C,kBAAkB;UAClBQ;QACD,IAAI,IAAI;QACR+E,IAAG,GAAIvF,kBAAkB;MAC1BuF,IAAI,CAACrF,EAAC,GAAIoF,EAAE,CAACE,OAAO;MACpBD,IAAI,CAACpF,EAAC,GAAImF,EAAE,CAACG,OAAO;MACpBF,IAAI,CAACnF,IAAII,KAAK,CAACJ,CAAC;MAChBmF,IAAI,CAAClF,IAAIG,KAAK,CAACH,CAAC;MAChBkF,IAAI,CAACtF,EAAC,GAAI,IAAI;IACf,CAAC;IACD;IACAyF,OAAOA,CAAC9C,CAAC,EAAE;MACVA,CAAC,CAACS,cAAc,CAAC,CAAC;MAClB;MACA,IAAG,IAAI,CAACjE,cAAa,IAAK,CAACwD,CAAC,CAACyC,aAAa,EAAC;QAC1C,OAAO,KAAK;MACb;MACA,IAAIC,EAAC,GAAI1C,CAAC,CAACyC,aAAY,GAAIzC,CAAC,CAACyC,aAAa,CAAC,CAAC,IAAIzC,CAAC;QAChD;UACC5C,kBAAkB,EAAE;YACnBC,EAAE;YACFC,EAAE;YACFC,EAAE;YACFC,CAAC;YACDC;UACD,CAAC;UACDG,KAAK;UACLa;QACD,IAAI,IAAI;QACRQ,GAAE,GAAIR,gBAAgB;QACtBsE,EAAC,GAAIL,EAAE,CAACE,OAAO;QACfI,EAAC,GAAIN,EAAE,CAACG,OAAO;QACfI,EAAC,GAAIF,EAAC,GAAIzF,EAAE;QACZ4F,EAAC,GAAIF,EAAC,GAAIzF,EAAE;QACZ4F,EAAC,GAAI3F,IAAIyF,EAAE;QACXG,EAAC,GAAI3F,IAAIyF,EAAE;MACZ,IAAI,CAAC7F,EAAE,EAAE;MACT,IAAI8F,EAAC,GAAI,CAAC,EAAE;QACXA,EAAC,GAAI,CAAC;MACP;MACA,IAAIC,EAAC,GAAI,CAAC,EAAE;QACXA,EAAC,GAAI,CAAC;MACP;MACA,IAAID,EAAC,GAAIlE,GAAG,CAAClE,KAAI,GAAI6C,KAAK,CAAC7C,KAAK,EAAE;QACjCoI,EAAC,GAAIlE,GAAG,CAAClE,KAAI,GAAI6C,KAAK,CAAC7C,KAAK;MAC7B;MACA,IAAIqI,EAAC,GAAInE,GAAG,CAAChE,MAAK,GAAI2C,KAAK,CAAC3C,MAAM,EAAE;QACnCmI,EAAC,GAAInE,GAAG,CAAChE,MAAK,GAAI2C,KAAK,CAAC3C,MAAM;MAC/B;MACA2C,KAAK,CAACJ,IAAI2F,EAAE;MACZvF,KAAK,CAACH,IAAI2F,EAAE;IACb,CAAC;IACD;IACMC,SAASA,CAACrD,CAAC,EAAE;MAClB,IAAI;UACF/C,SAAS;UACMW,KAAK,EAAE;YACrBQ,YAAY;YACZC;UACc;QACJ,IAAI,IAAI;QACpBtD,KAAI,GAAIsD,aAAa;QACrBpD,MAAK,GAAImD,YAAY;QACTkF,MAAK,GAAI,IAAI,CAAC1C,KAAK,CAAC0C,MAAM;QAC1BC,GAAE,GAAID,MAAM,CAACE,UAAU,CAAC,IAAI,CAAC;MAC1CF,MAAM,CAACvI,KAAI,GAAIA,KAAK;MACXuI,MAAM,CAACrI,MAAK,GAAIA,MAAM;MACtBsI,GAAG,CAACE,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE1I,KAAK,EAAEE,MAAM,CAAC;MAE3CsI,GAAG,CAACG,SAAQ,GAAI,eAAe;MAC/BH,GAAG,CAACI,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE5I,KAAK,EAAEE,MAAM,CAAC;MAEjCsI,GAAG,CAACK,SAAS,CAAC7I,KAAK,EAAE,CAAC,CAAC;MACdwI,GAAG,CAACM,MAAM,CAACC,IAAI,CAACC,EAAC,GAAI,EAAC,GAAI,GAAG,CAAC;MAE9BR,GAAG,CAACS,SAAS,CAAC/G,SAAS,EAAE,CAAC,EAAE,CAAC,EAAEmB,YAAY,EAAEC,aAAa,CAAC;MAC3D,IAAI4F,MAAK,GAAIX,MAAM,CAACY,SAAS,CAAClK,KAAK,CAAC,KAAK,CAAC,CAAC;MAEpD,IAAI,CAACkD,YAAW,GAAI+G,MAAM;MAC1B,IAAI,CAACnE,SAAS,CAAC,CAAC;IACX,CAAC;IACDqE,gBAAgBA,CAACnE,CAAC,EAAC;MACxBA,IAAIA,KAAKoE,MAAM,CAACC,KAAK;MACrB,IAAK;QAAEzG;MAAM,IAAI,IAAI;MACrB,IAAIoC,CAAC,CAACsE,UAAU,EAAE;QAAG;QACpB,IAAItE,CAAC,CAACsE,UAAS,GAAI,CAAC,EAAE;UAAE;UACvB,IAAI,CAACC,OAAO,CAAC3G,KAAK,CAACG,KAAI,IAAK,GAAE,GAAI,GAAE,GAAI,EAAEH,KAAK,CAACG,KAAK,CAAC;QACvD;QACA,IAAIiC,CAAC,CAACsE,UAAS,GAAI,CAAC,EAAE;UACrB,IAAI,CAACC,OAAO,CAAC3G,KAAK,CAACG,KAAI,IAAK,IAAI,IAAI,EAAEH,KAAK,CAACG,KAAK,CAAC;QACnD;MACD,OAAO,IAAIiC,CAAC,CAACwE,MAAM,EAAE;QAAG;QACvB,IAAIxE,CAAC,CAACwE,MAAK,GAAI,CAAC,EAAE;UAAE;UACnB,IAAI,CAACD,OAAO,CAAC3G,KAAK,CAACG,KAAI,IAAK,GAAE,GAAI,GAAE,GAAI,EAAEH,KAAK,CAACG,KAAK,CAAC;QACvD;QACA,IAAIiC,CAAC,CAACwE,MAAK,GAAI,CAAC,EAAE;UACjB,IAAI,CAACD,OAAO,CAAC3G,KAAK,CAACG,KAAI,IAAK,IAAI,IAAI,EAAEH,KAAK,CAACG,KAAK,CAAC;QACnD;MACD;IACK,CAAC;IACP;IACA0G,YAAYA,CAACzE,CAAC,EAAE;MACf,IAAIhE,IAAG,GAAI,IAAI;QACd;UACC4B;QACD,IAAI5B,IAAI;MACT4B,KAAK,CAACC,SAAQ,GAAI,IAAI;MAEtB,SAAS6G,IAAIA,GAAG;QACf,IAAI9G,KAAK,CAACC,SAAS,EAAE;UACpB,IAAIE,KAAI,GAAIH,KAAK,CAACG,KAAI,IAAK,GAAE,GAAI,GAAE,GAAI,EAAEH,KAAK,CAACG,KAAK;UACpD/B,IAAI,CAACuI,OAAO,CAACxG,KAAK,CAAC;UACnBsC,UAAU,CAAC,YAAW;YACrBqE,IAAI,CAAC,CAAC;UACP,CAAC,EAAE,EAAE,CAAC;QACP;MACD;MACAA,IAAI,CAAC,CAAC;IACP,CAAC;IACD;IACAC,UAAUA,CAAC3E,CAAC,EAAE;MACb,IAAI,CAACpC,KAAK,CAACC,SAAQ,GAAI,KAAK;IAC7B,CAAC;IACD;IACA+G,YAAYA,CAAC5E,CAAC,EAAE;MACf,IAAIhE,IAAG,GAAI,IAAI;QACd;UACC4B;QACD,IAAI5B,IAAI;MACT4B,KAAK,CAACE,SAAQ,GAAI,IAAI;MAEtB,SAAS4G,IAAIA,GAAG;QACf,IAAI9G,KAAK,CAACE,SAAS,EAAE;UACpB,IAAIC,KAAI,GAAIH,KAAK,CAACG,KAAI,IAAK,IAAI,IAAI,EAAEH,KAAK,CAACG,KAAK;UAChD/B,IAAI,CAACuI,OAAO,CAACxG,KAAK,CAAC;UACnBsC,UAAU,CAAC,YAAW;YACrBqE,IAAI,CAAC,CAAC;UACP,CAAC,EAAE,EAAE,CAAC;QACP;MACD;MACAA,IAAI,CAAC,CAAC;IACP,CAAC;IACD;IACAG,UAAUA,CAAC7E,CAAC,EAAE;MACb,IAAI;QACHpC;MACD,IAAI,IAAI;MACRA,KAAK,CAACE,SAAQ,GAAI,KAAK;IACxB,CAAC;IACDgH,UAAUA,CAAC9E,CAAC,EAAE;MACb,IAAI,CAACuE,OAAO,CAACvE,CAAC,CAACW,MAAM,CAACoE,KAAK,CAAC;IAC7B,CAAC;IACD;IACAR,OAAOA,CAACS,QAAQ,EAAE;MACjB,IAAIhJ,IAAG,GAAI,IAAI;QACd;UACCyC,gBAAgB;UAChBrB,kBAAkB;UAClBQ;QACD,IAAI,IAAI;QACR;UACCI,QAAQ;UACRC,SAAS;UACTC,QAAQ;UACRC,SAAS;UACTpD,KAAK;UACLE,MAAM;UACNuC,CAAC;UACDC,CAAC;UACDM;QACD,IAAIH,KAAK;QACTqB,GAAE,GAAIR,gBAAgB;QACtB;QACAwG,MAAK,GAAIhG,GAAG,CAAClE,KAAK;QAClBmK,OAAM,GAAIjG,GAAG,CAAChE,MAAM;QACpB;QACAkH,MAAK,GAAIjE,QAAO,GAAI,CAACF,QAAO,GAAIE,QAAQ,IAAI8G,QAAO,GAAI,GAAG;QAC1D5C,OAAM,GAAIjE,SAAQ,GAAI,CAACF,SAAQ,GAAIE,SAAS,IAAI6G,QAAO,GAAI,GAAG;QAC9D;QACAjC,EAAC,GAAIkC,MAAK,GAAI,IAAK9C,MAAK,GAAIpH,KAAK,IAAKkK,MAAK,GAAI,IAAIzH,CAAC,CAAC;QACrDwF,EAAC,GAAIkC,OAAM,GAAI,IAAK9C,OAAM,GAAInH,MAAM,IAAKiK,OAAM,GAAI,IAAIzH,CAAC,CAAC;;MAE1D;MACA,IAAIsF,EAAC,GAAI,CAAC,EAAE;QACXA,EAAC,GAAI,CAAC;MACP;MACA,IAAIC,EAAC,GAAI,CAAC,EAAE;QACXA,EAAC,GAAI,CAAC;MACP;MACA,IAAID,EAAC,GAAIkC,MAAK,GAAI9C,MAAM,EAAE;QACzBY,EAAC,GAAIkC,MAAK,GAAI9C,MAAM;MACrB;MACA,IAAIa,EAAC,GAAIkC,OAAM,GAAI9C,OAAO,EAAE;QAC3BY,EAAC,GAAIkC,OAAM,GAAI9C,OAAO;MACvB;;MAEA;MACAxE,KAAK,CAACJ,IAAIuF,EAAE;MACZnF,KAAK,CAACH,IAAIuF,EAAE;MACZpF,KAAK,CAAC7C,KAAI,GAAIoH,MAAM;MACpBvE,KAAK,CAAC3C,MAAK,GAAImH,OAAO;MACtBxE,KAAK,CAACG,KAAI,GAAIiH,QAAQ;MACtB3E,UAAU,CAAC,YAAW;QACrB,IAAIzC,KAAK,CAACG,KAAI,IAAKiH,QAAQ,EAAE;UAC5BhJ,IAAI,CAACuG,SAAS,CAAC,CAAC;QACjB;MACD,CAAC,EAAE,GAAG,CAAC;IACR,CAAC;IACA;IACKA,SAASA,CAACvC,CAAC,EAAE;MACT,IAAIhE,IAAG,GAAI,IAAI;QACX;UACXR,SAAS;UACTC,MAAM;UACSY,IAAI;UACJY,SAAS;UACTW,KAAK,EAAE;YACHJ,CAAC;YACDC,CAAC;YACD1C,KAAK;YACLE;UACJ,CAAC;UACDwD,gBAAgB,EAAE;YACdb;UACJ;QACJ,IAAI5B,IAAI;QACRsH,MAAK,GAAItH,IAAI,CAAC4E,KAAK,CAAC0C,MAAM;QAC1BC,GAAE,GAAID,MAAM,CAACE,UAAU,CAAC,IAAI,CAAC;MACjC,IAAIxD,CAAC,EAAE;QACH;QACAhE,IAAI,CAACoB,kBAAkB,CAACC,EAAC,GAAI,KAAK;MACtC;MACTiG,MAAM,CAACvI,KAAI,GAAIiB,IAAI,CAACjB,KAAK;MAChBuI,MAAM,CAACrI,MAAK,GAAIe,IAAI,CAACf,MAAM;MAC3BsI,GAAG,CAACE,SAAS,CAAC,CAAC,EAAE,CAAC,EAAEzH,IAAI,CAACjB,KAAK,EAAEiB,IAAI,CAACf,MAAM,CAAC;MAErD,IAAGO,SAAQ,IAAK,KAAK,EAAC;QACrB+H,GAAG,CAACG,SAAQ,GAAI,eAAe;MAChC,OAAM;QACL;QACAH,GAAG,CAACG,SAAQ,GAAIjI,MAAM;MACvB;MACA8H,GAAG,CAACI,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE3H,IAAI,CAACjB,KAAK,EAAEiB,IAAI,CAACf,MAAM,CAAC;MAElCsI,GAAG,CAACS,SAAS,CAAC/G,SAAS,EAAEO,IAAII,KAAK,EAAEH,IAAIG,KAAK,EAAE7C,KAAI,GAAI6C,KAAK,EAAE3C,MAAK,GAAI2C,KAAK,CAAC;MAC7E5B,IAAI,CAACmB,YAAW,GAAImG,MAAM,CAACY,SAAS,CAAC7H,IAAI,CAAC;IAC9C,CAAC;IACP8I,aAAaA,GAAE;MACd,IAAI;QACHzK,GAAG;QACHyC,YAAY;QACZ/C,KAAK;QACLG;MACD,IAAI,IAAI;MACR,IAAI,CAAC+F,KAAK,CAAC,cAAc,EAAEnD,YAAY,EAAE/C,KAAK,EAAEG,EAAE,CAAC;MACnD,IAAG,OAAOG,GAAE,IAAK,QAAO,IAAKA,GAAG,EAAC;QAChC,IAAI,CAAC0K,MAAM,CAAC,CAAC;MACd,CAAC,MAAI;QACJ,IAAI,CAACjF,GAAG,CAAC,CAAC;MACX;IACD,CAAC;IACD;IACAiF,MAAMA,GAAG;MACR,IAAIpJ,IAAG,GAAI,IAAI;QACd;UACCI,IAAI;UACJZ,SAAS;UACTa,IAAI;UACJ3B,GAAG;UACHC,MAAM;UACNG,OAAO;UACPV,KAAK;UACLG,EAAE;UACF4C,YAAY;UACZzB,eAAe;UACfC;QACD,IAAI,IAAI;QACR0J,MAAK,GAAI,IAAI9I,QAAQ,CAAC,CAAC;;MAExB;MACA,IAAI,OAAO5B,MAAK,IAAK,QAAO,IAAKA,MAAM,EAAE;QACxCC,MAAM,CAAC0K,IAAI,CAAC3K,MAAM,CAAC,CAAC4K,OAAO,CAAEC,CAAC,IAAK;UAClCH,MAAM,CAACI,MAAM,CAACD,CAAC,EAAE7K,MAAM,CAAC6K,CAAC,CAAC,CAAC;QAC5B,CAAC;MACF;;MAEA;MACAH,MAAM,CAACI,MAAM,CAACrL,KAAK,EAAEH,SAAS,CAACkD,YAAY,EAAEd,IAAI,CAAC,EAAEjC,KAAI,GAAI,GAAE,GAAIoB,SAAS,CAAC;;MAG5E;MACA,MAAMkK,cAAa,GAAI,UAASrB,KAAK,EAAE;QACtC,IAAIA,KAAK,CAACsB,gBAAgB,EAAE;UAC3B3J,IAAI,CAACa,QAAO,GAAI,GAAE,GAAIiH,IAAI,CAAC8B,KAAK,CAACvB,KAAK,CAACwB,MAAM,IAAIxB,KAAK,CAACyB,KAAK;QAC7D;MACD,CAAC;;MAED;MACA9J,IAAI,CAACuD,KAAK,CAAC,CAAC;MACZvD,IAAI,CAACY,OAAM,GAAI,CAAC;MAChBZ,IAAI,CAACuE,OAAO,CAAC,CAAC,CAAC;MACf,IAAIwF,OAAO,CAAC,UAASC,OAAO,EAAEC,MAAM,EAAE;QACrC,IAAIC,MAAK,GAAI,IAAIC,cAAc,CAAC,CAAC;QACjCD,MAAM,CAACE,IAAI,CAACzK,MAAM,EAAEjB,GAAG,EAAE,IAAI,CAAC;QAC9BwL,MAAM,CAACxK,eAAc,GAAIA,eAAe;QACxCwK,MAAM,CAACG,kBAAiB,GAAI,YAAW;UACtC,IAAI,IAAI,CAACC,UAAS,KAAM,CAAC,EAAE;YAC1B;UACD;UACA,IAAI,IAAI,CAACC,MAAK,KAAM,GAAE,IAAK,IAAI,CAACA,MAAK,KAAM,GAAE,IAAK,IAAI,CAACC,KAAI,KAAK,GAAE,EAAI;YACrER,OAAO,CAACS,IAAI,CAACC,KAAK,CAAC,IAAI,CAACC,YAAY,CAAC,CAAC;UACvC,OAAO;YACNV,MAAM,CAAC,IAAI,CAACM,MAAM,CAAC;UACpB;QACD,CAAC;QACDL,MAAM,CAACd,MAAM,CAAC3F,gBAAgB,CAAC,UAAU,EAAEiG,cAAc,EAAE,KAAK,CAAC,EAAE;QACnE;QACA,IAAI,OAAO5K,OAAM,IAAK,QAAO,IAAKA,OAAO,EAAE;UAC1CF,MAAM,CAAC0K,IAAI,CAACxK,OAAO,CAAC,CAACyK,OAAO,CAAEC,CAAC,IAAK;YACnCU,MAAM,CAACU,gBAAgB,CAACpB,CAAC,EAAE1K,OAAO,CAAC0K,CAAC,CAAC,CAAC;UACvC,CAAC;QACF;QACAU,MAAM,CAACW,IAAI,CAACxB,MAAM,CAAC;MACpB,CAAC,CAAC,CAACyB,IAAI;MACN;MACA,UAASC,OAAO,EAAE;QACjB,IAAI/K,IAAI,CAACxB,UAAU,EAAE;UACpBwB,IAAI,CAACY,OAAM,GAAI,CAAC;UAChBZ,IAAI,CAACsE,KAAK,CAAC,qBAAqB,EAAEyG,OAAO,EAAE3M,KAAK,EAAEG,EAAE,CAAC;QACtD;MACD,CAAC;MACD;MACA,UAASyM,GAAG,EAAE;QACb,IAAIhL,IAAI,CAACxB,UAAU,EAAE;UACpBwB,IAAI,CAACY,OAAM,GAAI,CAAC;UAChBZ,IAAI,CAACc,QAAO,GAAI,IAAI;UACpBd,IAAI,CAACe,QAAO,GAAIX,IAAI,CAAC6K,IAAI;UACzBjL,IAAI,CAACsE,KAAK,CAAC,kBAAkB,EAAE0G,GAAG,EAAE5M,KAAK,EAAEG,EAAE,CAAC;QAC/C;MACD,CACD,CAAC;IACF;EACD;AACD","names":["language","mimes","data2blob","effectRipple","props","field","type","String","ki","modelValue","Boolean","url","params","Object","default","headers","width","Number","height","noRotate","noCircle","noSquare","maxSize","langType","langExt","imgFormat","imgBgc","withCredentials","method","initialImgUrl","allowImgFormat","Array","data","that","isSupported","tempImgFormat","indexOf","lang","mime","assign","FormData","isSupportTouch","document","hasOwnProperty","step","loading","progress","hasError","errorMsg","ratio","sourceImg","sourceImgUrl","createImgUrl","sourceImgMouseDown","on","mX","mY","x","y","previewContainer","sourceImgContainer","scale","zoomAddOn","zoomSubOn","range","maxWidth","maxHeight","minWidth","minHeight","naturalWidth","naturalHeight","computed","progressStyle","sourceImgStyle","sourceImgMasking","top","left","sic","sicRatio","w","h","sourceImgShadeStyle","sim","previewStyle","pc","pcRatio","watch","newValue","reset","created","addEventListener","handleEscClose","beforeUnmount","removeEventListener","mounted","startCrop","methods","e","key","keyCode","off","ripple","setTimeout","$emit","setStep","no","preventDefault","handleClick","target","$refs","fileinput","activeElement","click","handleChange","files","dataTransfer","checkFile","setSourceImg","file","error","onlyImg","size","outOfSize","name","fr","FileReader","onload","result","readAsDataURL","img","Image","src","nWidth","nHeight","nRatio","lowestPx","createImg","imgStartMove","targetTouches","et","simd","screenX","screenY","imgMove","nX","nY","dX","dY","rX","rY","rotateImg","canvas","ctx","getContext","clearRect","fillStyle","fillRect","translate","rotate","Math","PI","drawImage","imgUrl","toDataURL","handleMouseWheel","window","event","wheelDelta","zoomImg","detail","startZoomAdd","zoom","endZoomAdd","startZoomSub","endZoomSub","zoomChange","value","newRange","sWidth","sHeight","prepareUpload","upload","fmData","keys","forEach","k","append","uploadProgress","lengthComputable","round","loaded","total","Promise","resolve","reject","client","XMLHttpRequest","open","onreadystatechange","readyState","status","staus","JSON","parse","responseText","setRequestHeader","send","then","resData","sts","fail"],"sourceRoot":"","sources":["F:\\personalSpace\\lx-bishe\\movie_recommendation_system_vue\\node_modules\\vue-image-crop-upload\\upload-3.vue"],"sourcesContent":["<template>\n<div class=\"vue-image-crop-upload\" v-show=\"modelValue\">\n\t<div class=\"vicp-wrap\">\n\t\t<div class=\"vicp-close\" @click=\"off\">\n\t\t\t<i class=\"vicp-icon4\"></i>\n\t\t</div>\n\n\t\t<div class=\"vicp-step1\" v-show=\"step == 1\">\n\t\t\t<div class=\"vicp-drop-area\" @dragleave=\"preventDefault\" @dragover=\"preventDefault\" @dragenter=\"preventDefault\" @click=\"handleClick\" @drop=\"handleChange\">\n\t\t\t\t<i class=\"vicp-icon1\" v-show=\"loading != 1\">\n\t\t\t\t<i class=\"vicp-icon1-arrow\"></i>\n\t\t\t\t<i class=\"vicp-icon1-body\"></i>\n\t\t\t\t<i class=\"vicp-icon1-bottom\"></i>\n\t\t\t\t</i>\n\t\t\t\t<span class=\"vicp-hint\" v-show=\"loading !== 1\">{{ lang.hint }}</span>\n\t\t\t\t<span class=\"vicp-no-supported-hint\" v-show=\"!isSupported\">{{ lang.noSupported }}</span>\n\t\t\t\t<input type=\"file\" accept=\"image/*\" v-show=\"false\" v-if=\"step == 1\" @change=\"handleChange\" ref=\"fileinput\">\n\t\t\t</div>\n\t\t\t<div class=\"vicp-error\" v-show=\"hasError\">\n\t\t\t\t<i class=\"vicp-icon2\"></i> {{ errorMsg }}\n\t\t\t</div>\n\t\t\t<div class=\"vicp-operate\">\n\t\t\t\t<a @click=\"off\" @mousedown=\"ripple\">{{ lang.btn.off }}</a>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"vicp-step2\" v-if=\"step == 2\">\n\t\t\t<div class=\"vicp-crop\">\n\t\t\t\t<div class=\"vicp-crop-left\" v-show=\"true\">\n\t\t\t\t\t<div class=\"vicp-img-container\" @wheel.prevent=\"handleMouseWheel\">\n\t\t\t\t\t\t<img :src=\"sourceImgUrl\" :style=\"sourceImgStyle\" class=\"vicp-img\" draggable=\"false\"\n\t\t\t\t\t\t\t@drag=\"preventDefault\"\n\t\t\t\t\t\t\t@dragstart=\"preventDefault\"\n\t\t\t\t\t\t\t@dragend=\"preventDefault\"\n\t\t\t\t\t\t\t@dragleave=\"preventDefault\"\n\t\t\t\t\t\t\t@dragover=\"preventDefault\"\n\t\t\t\t\t\t\t@dragenter=\"preventDefault\"\n\t\t\t\t\t\t\t@drop=\"preventDefault\"\n\t\t\t\t\t\t\t@touchstart=\"imgStartMove\"\n\t\t\t\t\t\t\t@touchmove=\"imgMove\"\n\t\t\t\t\t\t\t@touchend=\"createImg\"\n\t\t\t\t\t\t\t@touchcancel=\"createImg\"\n\t\t\t\t\t\t\t@mousedown=\"imgStartMove\"\n\t\t\t\t\t\t\t@mousemove=\"imgMove\"\n\t\t\t\t\t\t\t@mouseup=\"createImg\"\n\t\t\t\t\t\t\t@mouseout=\"createImg\"\n\t\t\t\t\t\t\tref=\"img\">\n\t\t\t\t\t\t<div class=\"vicp-img-shade vicp-img-shade-1\" :style=\"sourceImgShadeStyle\"></div>\n\t\t\t\t\t\t<div class=\"vicp-img-shade vicp-img-shade-2\" :style=\"sourceImgShadeStyle\"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"vicp-range\">\n\t\t\t\t\t\t<input type=\"range\" v-model=\"scale.range\" step=\"1\" min=\"0\" max=\"100\" @mousemove=\"zoomChange\">\n\t\t\t\t\t\t<i @mousedown=\"startZoomSub\" @mouseout=\"endZoomSub\" @mouseup=\"endZoomSub\" class=\"vicp-icon5\"></i>\n\t\t\t\t\t\t<i @mousedown=\"startZoomAdd\" @mouseout=\"endZoomAdd\" @mouseup=\"endZoomAdd\" class=\"vicp-icon6\"></i>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"vicp-rotate\" v-if=\"!noRotate\">\n                        <i @click=\"rotateImg\">↻</i>\n                    </div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"vicp-crop-right\" v-show=\"true\">\n\t\t\t\t\t<div class=\"vicp-preview\">\n\t\t\t\t\t\t<div class=\"vicp-preview-item\" v-if=\"!noSquare\">\n\t\t\t\t\t\t\t<img :src=\"createImgUrl\" :style=\"previewStyle\">\n\t\t\t\t\t\t\t<span>{{ lang.preview }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"vicp-preview-item vicp-preview-item-circle\" v-if=\"!noCircle\">\n\t\t\t\t\t\t\t<img :src=\"createImgUrl\" :style=\"previewStyle\">\n\t\t\t\t\t\t\t<span>{{ lang.preview }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"vicp-operate\">\n\t\t\t\t<a @click=\"setStep(1)\" @mousedown=\"ripple\">{{ lang.btn.back }}</a>\n\t\t\t\t<a class=\"vicp-operate-btn\" @click=\"prepareUpload\" @mousedown=\"ripple\">{{ lang.btn.save }}</a>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"vicp-step3\" v-if=\"step == 3\">\n\t\t\t<div class=\"vicp-upload\">\n\t\t\t\t<span class=\"vicp-loading\" v-show=\"loading === 1\">{{ lang.loading }}</span>\n\t\t\t\t<div class=\"vicp-progress-wrap\">\n\t\t\t\t\t<span class=\"vicp-progress\" v-show=\"loading === 1\" :style=\"progressStyle\"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"vicp-error\" v-show=\"hasError\">\n\t\t\t\t\t<i class=\"vicp-icon2\"></i> {{ errorMsg }}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"vicp-success\" v-show=\"loading === 2\">\n\t\t\t\t\t<i class=\"vicp-icon3\"></i> {{ lang.success }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"vicp-operate\">\n\t\t\t\t<a @click=\"setStep(2)\" @mousedown=\"ripple\">{{ lang.btn.back }}</a>\n\t\t\t\t<a @click=\"off\" @mousedown=\"ripple\">{{ lang.btn.close }}</a>\n\t\t\t</div>\n\t\t</div>\n\t\t<canvas v-show=\"false\" :width=\"width\" :height=\"height\" ref=\"canvas\"></canvas>\n\t</div>\n</div>\n</template>\n\n<script>\n'use strict';\nimport language from './utils/language.js';\nimport mimes from './utils/mimes.js';\nimport data2blob from './utils/data2blob.js';\nimport effectRipple from './utils/effectRipple.js';\n\nexport default {\n\tprops: {\n\t\t// 域，上传文件name，触发事件会带上（如果一个页面多个图片上传控件，可以做区分\n\t\tfield: {\n\t\t\ttype: String,\n\t\t\t'default': 'avatar'\n\t\t},\n\t\t// 原名key，类似于id，触发事件会带上（如果一个页面多个图片上传控件，可以做区分\n\t\tki: {\n\t\t\ttype: String,\n\t\t\t'default': '0'\n\t\t},\n\t\t// 显示该控件与否\n\t\tmodelValue: {\n\t\t\ttype: Boolean,\n\t\t\t'default': true\n\t\t},\n\t\t// 上传地址\n\t\turl: {\n\t\t\ttype: String,\n\t\t\t'default': ''\n\t\t},\n\t\t// 其他要上传文件附带的数据，对象格式\n\t\tparams: {\n\t\t\ttype: Object,\n\t\t\t'default': ()=>null\n\t\t},\n\t\t//Add custom headers\n\t\theaders: {\n\t\t\ttype: Object,\n\t\t\t'default': ()=>null\n\t\t},\n\t\t// 剪裁图片的宽\n\t\twidth: {\n\t\t\ttype: Number,\n\t\t\tdefault: 200\n\t\t},\n\t\t// 剪裁图片的高\n\t\theight: {\n\t\t\ttype: Number,\n\t\t\tdefault: 200\n\t\t},\n\t\t// 不显示旋转功能\n\t\tnoRotate: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true\n\t\t},\n\t\t// 不预览圆形图片\n\t\tnoCircle: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false\n\t\t},\n\t\t// 不预览方形图片\n\t\tnoSquare: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false\n\t\t},\n\t\t// 单文件大小限制\n\t\tmaxSize: {\n\t\t\ttype: Number,\n\t\t\t'default': 10240\n\t\t},\n\t\t// 语言类型\n\t\tlangType: {\n\t\t\ttype: String,\n\t\t\t'default': 'zh'\n\t\t},\n\t\t// 语言包\n\t\tlangExt: {\n\t\t\ttype: Object,\n\t\t\t'default': ()=>null\n\t\t},\n\t\t// 图片上传格式\n\t\timgFormat: {\n\t\t\ttype: String,\n\t\t\t'default': 'png'\n\t\t},\n\t\t// 图片背景 jpg情况下生效\n\t\timgBgc: {\n\t\t\ttype: String,\n\t\t\t'default': '#fff'\n\t\t},\n\t\t// 是否支持跨域\n\t\twithCredentials: {\n\t\t\ttype: Boolean,\n\t\t\t'default': false\n\t\t},\n\t\tmethod: {\n\t\t\ttype: String,\n\t\t\t'default': 'POST'\n\t\t},\n\t\tinitialImgUrl: {\n\t\t\ttype: String,\n\t\t\t'default': ''\n\t    },\n\t    allowImgFormat: {\n\t    \ttype: Array,\n\t    \t'default': ()=>[\n\t\t    \t'gif',\n\t\t\t'jpg',\n\t\t\t'png'\n\t\t\t]\n\t    }\n\t},\n\n\tdata() {\n\t\tlet that = this,\n\t\t\t{\n\t\t\t\timgFormat,\n\t\t\t\tallowImgFormat,\n\t\t\t\tlangType,\n\t\t\t\tlangExt,\n\t\t\t\twidth,\n\t\t\t\theight\n\t\t\t} = that,\n\t\t\tisSupported = true,\n\t\t\ttempImgFormat = allowImgFormat.indexOf(imgFormat) === -1 ? 'jpg' : imgFormat,\n\t\t\tlang = language[langType] ? language[langType] : language['en'],\n\t\t\tmime = mimes[tempImgFormat];\n\t\t// 规范图片格式\n\t\t// that.imgFormat = tempImgFormat;\n\n\t\tif (langExt) {\n\t\t\tObject.assign(lang, langExt);\n\t\t}\n\t\tif (typeof FormData != 'function') {\n\t\t\tisSupported = false;\n\t\t}\n\t\treturn {\n\t\t\t// 图片的mime\n\t\t\tmime,\n\n\t\t\t// 语言包\n\t\t\tlang,\n\n\t\t\t// 浏览器是否支持该控件\n\t\t\tisSupported,\n\t\t\t// 浏览器是否支持触屏事件\n\t\t\tisSupportTouch: document.hasOwnProperty(\"ontouchstart\"),\n\n\t\t\t// 步骤\n\t\t\tstep: 1, //1选择文件 2剪裁 3上传\n\n\t\t\t// 上传状态及进度\n\t\t\tloading: 0, //0未开始 1正在 2成功 3错误\n\t\t\tprogress: 0,\n\n\t\t\t// 是否有错误及错误信息\n\t\t\thasError: false,\n\t\t\terrorMsg: '',\n\n\t\t\t// 需求图宽高比\n\t\t\tratio: width / height,\n\n\t\t\t// 原图地址、生成图片地址\n\t\t\tsourceImg: null,\n\t\t\tsourceImgUrl: this.initialImgUrl,\n\t\t\tcreateImgUrl: this.initialImgUrl,\n\n\t\t\t// 原图片拖动事件初始值\n\t\t\tsourceImgMouseDown: {\n\t\t\t\ton: false,\n\t\t\t\tmX: 0, //鼠标按下的坐标\n\t\t\t\tmY: 0,\n\t\t\t\tx: 0, //scale原图坐标\n\t\t\t\ty: 0\n\t\t\t},\n\n\t\t\t// 生成图片预览的容器大小\n\t\t\tpreviewContainer: {\n\t\t\t\twidth: 100,\n\t\t\t\theight: 100\n\t\t\t},\n\n\t\t\t// 原图容器宽高\n\t\t\tsourceImgContainer: { // sic\n\t\t\t\twidth: 240,\n\t\t\t\theight: 184 // 如果生成图比例与此一致会出现bug，先改成特殊的格式吧，哈哈哈\n\t\t\t},\n\n\t\t\t// 原图展示属性\n\t\t\tscale: {\n\t\t\t\tzoomAddOn: false, //按钮缩放事件开启\n\t\t\t\tzoomSubOn: false, //按钮缩放事件开启\n\t\t\t\trange: 1, //最大100\n\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tmaxWidth: 0,\n\t\t\t\tmaxHeight: 0,\n\t\t\t\tminWidth: 0, //最宽\n\t\t\t\tminHeight: 0,\n\t\t\t\tnaturalWidth: 0, //原宽\n\t\t\t\tnaturalHeight: 0\n\t\t\t}\n\t\t}\n\t},\n\n\tcomputed: {\n\t\t// 进度条样式\n\t\tprogressStyle() {\n\t\t\tlet {\n\t\t\t\tprogress\n\t\t\t} = this;\n\t\t\treturn {\n\t\t\t\twidth: progress + '%'\n\t\t\t}\n\t\t},\n\t\t// 原图样式\n\t\tsourceImgStyle() {\n\t\t\tlet {\n\t\t\t\t\tscale,\n\t\t\t\t\tsourceImgMasking\n\t\t\t\t} = this,\n\t\t\t\ttop = scale.y + sourceImgMasking.y + 'px',\n\t\t\t\tleft = scale.x + sourceImgMasking.x + 'px';\n\t\t\treturn {\n\t\t\t\ttop,\n\t\t\t\tleft,\n\t\t\t\twidth: scale.width + 'px',\n\t\t\t\theight: scale.height + 'px',// 兼容 Opera\n\t\t\t}\n\t\t},\n\t\t// 原图蒙版属性\n\t\tsourceImgMasking() {\n\t\t\tlet {\n\t\t\t\t\twidth,\n\t\t\t\t\theight,\n\t\t\t\t\tratio,\n\t\t\t\t\tsourceImgContainer\n\t\t\t\t} = this,\n\t\t\t\tsic = sourceImgContainer,\n\t\t\t\tsicRatio = sic.width / sic.height, // 原图容器宽高比\n\t\t\t\tx = 0,\n\t\t\t\ty = 0,\n\t\t\t\tw = sic.width,\n\t\t\t\th = sic.height,\n\t\t\t\tscale = 1;\n\t\t\tif (ratio < sicRatio) {\n\t\t\t\tscale = sic.height / height;\n\t\t\t\tw = sic.height * ratio;\n\t\t\t\tx = (sic.width - w) / 2;\n\t\t\t}\n\t\t\tif (ratio > sicRatio) {\n\t\t\t\tscale = sic.width / width;\n\t\t\t\th = sic.width / ratio;\n\t\t\t\ty = (sic.height - h) / 2;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tscale, // 蒙版相对需求宽高的缩放\n\t\t\t\tx,\n\t\t\t\ty,\n\t\t\t\twidth: w,\n\t\t\t\theight: h\n\t\t\t};\n\t\t},\n\t\t// 原图遮罩样式\n\t\tsourceImgShadeStyle() {\n\t\t\tlet {\n\t\t\t\t\tsourceImgMasking,\n\t\t\t\t\tsourceImgContainer\n\t\t\t\t} = this,\n\t\t\t\tsic = sourceImgContainer,\n\t\t\t\tsim = sourceImgMasking,\n\t\t\t\tw = sim.width == sic.width ? sim.width : (sic.width - sim.width) / 2,\n\t\t\t\th = sim.height == sic.height ? sim.height : (sic.height - sim.height) / 2;\n\t\t\treturn {\n\t\t\t\twidth: w + 'px',\n\t\t\t\theight: h + 'px'\n\t\t\t};\n\t\t},\n\t\tpreviewStyle() {\n\t\t\tlet {\n\t\t\t\t\twidth,\n\t\t\t\t\theight,\n\t\t\t\t\tratio,\n\t\t\t\t\tpreviewContainer\n\t\t\t\t} = this,\n\t\t\t\tpc = previewContainer,\n\t\t\t\tw = pc.width,\n\t\t\t\th = pc.height,\n\t\t\t\tpcRatio = w / h;\n\t\t\tif (ratio < pcRatio) {\n\t\t\t\tw = pc.height * ratio;\n\t\t\t}\n\t\t\tif (ratio > pcRatio) {\n\t\t\t\th = pc.width / ratio;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\twidth: w + 'px',\n\t\t\t\theight: h + 'px'\n\t\t\t};\n\t\t}\n\t},\n\n\twatch: {\n\t\tmodelValue(newValue) {\n\t\t\tif (newValue && this.loading != 1) {\n\t\t\t\tthis.reset();\n\t\t\t}\n\t\t}\n\t},\n\n\tcreated(){\n\t\t// 绑定按键esc隐藏此插件事件\n\t\tdocument.addEventListener('keyup', this.handleEscClose )\n\t},\n\n\tbeforeUnmount(){\n\t\tdocument.removeEventListener('keyup', this.handleEscClose )\n\t},\n\n\tmounted() {\n\t\tif (this.sourceImgUrl) {\n\t\t\tthis.startCrop();\n\t\t}\n\t},\n\n\tmethods: {\n\t\thandleEscClose(e){\n\t\t\tif(this.modelValue && (e.key == 'Escape' || e.keyCode == 27)){\n\t\t\t\tthis.off();\n\t\t\t}\n\t\t},\n\t\t// 点击波纹效果\n\t\tripple(e) {\n\t\t\teffectRipple(e);\n\t\t},\n\t\t// 关闭控件\n\t\toff() {\n\t\t\tsetTimeout(()=> {\n\t\t\t\tthis.$emit('update:modelValue', false);\n\t\t\t\tif(this.step == 3 && this.loading == 2){\n\t\t\t\t\tthis.setStep(1);\n\t\t\t\t}\n\t\t\t}, 200);\n\t\t},\n\t\t// 设置步骤\n\t\tsetStep(no) {\n\t\t\t// 延时是为了显示动画效果呢，哈哈哈\n\t\t\tsetTimeout(()=> {\n\t\t\t\tthis.step = no;\n\t\t\t}, 200);\n\t\t},\n\n\t\t/* 图片选择区域函数绑定\n\t\t ---------------------------------------------------------------*/\n\t\tpreventDefault(e) {\n\t\t\te.preventDefault();\n\t\t\treturn false;\n\t\t},\n\t\thandleClick(e) {\n\t\t\tif (this.loading !== 1) {\n\t\t\t\tif (e.target !== this.$refs.fileinput) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tif (document.activeElement !== this.$refs) {\n\t\t\t\t\t\tthis.$refs.fileinput.click();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\thandleChange(e) {\n\t\t\te.preventDefault();\n\t\t\tif (this.loading !== 1) {\n\t\t\t\tlet files = e.target.files || e.dataTransfer.files;\n\t\t\t\tthis.reset();\n\t\t\t\tif (this.checkFile(files[0])) {\n\t\t\t\t\tthis.setSourceImg(files[0]);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t/* ---------------------------------------------------------------*/\n\n\t\t// 检测选择的文件是否合适\n\t\tcheckFile(file) {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\tlang,\n\t\t\t\t\tmaxSize\n\t\t\t\t} = that;\n\t\t\t// 仅限图片\n\t\t\tif (file.type.indexOf('image') === -1) {\n\t\t\t\tthat.hasError = true;\n\t\t\t\tthat.errorMsg = lang.error.onlyImg;\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// 超出大小\n\t\t\tif (file.size / 1024 > maxSize) {\n\t\t\t\tthat.hasError = true;\n\t\t\t\tthat.errorMsg = lang.error.outOfSize + maxSize + 'kb';\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t},\n\t\t// 重置控件\n\t\treset() {\n\t\t\tlet that = this;\n\t\t\tthat.loading = 0;\n\t\t\tthat.hasError = false;\n\t\t\tthat.errorMsg = '';\n\t\t\tthat.progress = 0;\n\t\t},\n\t\t// 设置图片源\n\t\tsetSourceImg(file) {\n\t\t\tthis.$emit('src-file-set', file.name, file.type, file.size);\n\t\t\tlet that = this,\n\t\t\t\tfr = new FileReader();\n\t\t\tfr.onload = function(e) {\n\t\t\t\tthat.sourceImgUrl = fr.result;\n\t\t\t\tthat.startCrop();\n\t\t\t}\n\t\t\tfr.readAsDataURL(file);\n\t\t},\n\t\t// 剪裁前准备工作\n\t\tstartCrop() {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\twidth,\n\t\t\t\t\theight,\n\t\t\t\t\tratio,\n\t\t\t\t\tscale,\n\t\t\t\t\tsourceImgUrl,\n\t\t\t\t\tsourceImgMasking,\n\t\t\t\t\tlang\n\t\t\t\t} = that,\n\t\t\t\tsim = sourceImgMasking,\n\t\t\t\timg = new Image();\n\t\t\timg.src = sourceImgUrl;\n\t\t\timg.onload = function() {\n\t\t\t\tlet nWidth = img.naturalWidth,\n\t\t\t\t\tnHeight = img.naturalHeight,\n\t\t\t\t\tnRatio = nWidth / nHeight,\n\t\t\t\t\tw = sim.width,\n\t\t\t\t\th = sim.height,\n\t\t\t\t\tx = 0,\n\t\t\t\t\ty = 0;\n\t\t\t\t// 图片像素不达标\n\t\t\t\tif (nWidth < width || nHeight < height) {\n\t\t\t\t\tthat.hasError = true;\n\t\t\t\t\tthat.errorMsg = lang.error.lowestPx + width + '*' + height;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif (ratio > nRatio) {\n\t\t\t\t\th = w / nRatio;\n\t\t\t\t\ty = (sim.height - h) / 2;\n\t\t\t\t}\n\t\t\t\tif (ratio < nRatio) {\n\t\t\t\t\tw = h * nRatio;\n\t\t\t\t\tx = (sim.width - w) / 2;\n\t\t\t\t}\n\t\t\t\tscale.range = 0;\n\t\t\t\tscale.x = x;\n\t\t\t\tscale.y = y;\n\t\t\t\tscale.width = w;\n\t\t\t\tscale.height = h;\n\t\t\t\tscale.minWidth = w;\n\t\t\t\tscale.minHeight = h;\n\t\t\t\tscale.maxWidth = nWidth * sim.scale;\n\t\t\t\tscale.maxHeight = nHeight * sim.scale;\n\t\t\t\tscale.naturalWidth = nWidth;\n\t\t\t\tscale.naturalHeight = nHeight;\n\t\t\t\tthat.sourceImg = img;\n\t\t\t\tthat.createImg();\n\t\t\t\tthat.setStep(2);\n\t\t\t};\n\t\t},\n\t\t// 鼠标按下图片准备移动\n\t\timgStartMove(e) {\n\t\t\te.preventDefault();\n\t\t\t// 支持触摸事件，则鼠标事件无效\n\t\t\tif(this.isSupportTouch && !e.targetTouches){\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tlet et = e.targetTouches ? e.targetTouches[0] : e,\n\t\t\t\t{\n\t\t\t\t\tsourceImgMouseDown,\n\t\t\t\t\tscale\n\t\t\t\t} = this,\n\t\t\t\tsimd = sourceImgMouseDown;\n\t\t\tsimd.mX = et.screenX;\n\t\t\tsimd.mY = et.screenY;\n\t\t\tsimd.x = scale.x;\n\t\t\tsimd.y = scale.y;\n\t\t\tsimd.on = true;\n\t\t},\n\t\t// 鼠标按下状态下移动，图片移动\n\t\timgMove(e) {\n\t\t\te.preventDefault();\n\t\t\t// 支持触摸事件，则鼠标事件无效\n\t\t\tif(this.isSupportTouch && !e.targetTouches){\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tlet et = e.targetTouches ? e.targetTouches[0] : e,\n\t\t\t\t{\n\t\t\t\t\tsourceImgMouseDown: {\n\t\t\t\t\t\ton,\n\t\t\t\t\t\tmX,\n\t\t\t\t\t\tmY,\n\t\t\t\t\t\tx,\n\t\t\t\t\t\ty\n\t\t\t\t\t},\n\t\t\t\t\tscale,\n\t\t\t\t\tsourceImgMasking\n\t\t\t\t} = this,\n\t\t\t\tsim = sourceImgMasking,\n\t\t\t\tnX = et.screenX,\n\t\t\t\tnY = et.screenY,\n\t\t\t\tdX = nX - mX,\n\t\t\t\tdY = nY - mY,\n\t\t\t\trX = x + dX,\n\t\t\t\trY = y + dY;\n\t\t\tif (!on) return;\n\t\t\tif (rX > 0) {\n\t\t\t\trX = 0;\n\t\t\t}\n\t\t\tif (rY > 0) {\n\t\t\t\trY = 0;\n\t\t\t}\n\t\t\tif (rX < sim.width - scale.width) {\n\t\t\t\trX = sim.width - scale.width;\n\t\t\t}\n\t\t\tif (rY < sim.height - scale.height) {\n\t\t\t\trY = sim.height - scale.height;\n\t\t\t}\n\t\t\tscale.x = rX;\n\t\t\tscale.y = rY;\n\t\t},\n\t\t// 顺时针旋转图片\n        rotateImg(e) {\n\t\t\tlet {\n\t\t\t\t\tsourceImg,\n                    scale: {\n\t\t\t\t\t\tnaturalWidth,\n\t\t\t\t\t\tnaturalHeight,\n                    }\n                } = this,\n\t\t\t\twidth = naturalHeight,\n\t\t\t\theight = naturalWidth,\n                canvas = this.$refs.canvas,\n                ctx = canvas.getContext('2d');\n\t\t\tcanvas.width = width;\n            canvas.height = height;\n            ctx.clearRect(0, 0, width, height);\n\n\t\t\tctx.fillStyle = 'rgba(0,0,0,0)';\n\t\t\tctx.fillRect(0, 0, width, height);\n\n\t\t\tctx.translate(width, 0);\n            ctx.rotate(Math.PI * 90 / 180);\n\n            ctx.drawImage(sourceImg, 0, 0, naturalWidth, naturalHeight);\n            let imgUrl = canvas.toDataURL(mimes['png']);\n\n\t\t\tthis.sourceImgUrl = imgUrl;\n\t\t\tthis.startCrop();\n        },\n        handleMouseWheel(e){\n\t\t\te = e || window.event;\n\t\t\tlet \t{ scale } = this;\n\t\t\tif (e.wheelDelta) {  //判断浏览器IE，谷歌滑轮事件\n\t\t\t\tif (e.wheelDelta > 0) { //当滑轮向上滚动时\n\t\t\t\t\tthis.zoomImg(scale.range >= 100 ? 100 : ++scale.range);\n\t\t\t\t}\n\t\t\t\tif (e.wheelDelta < 0) {\n\t\t\t\t\tthis.zoomImg(scale.range <= 0 ? 0 : --scale.range);\n\t\t\t\t}\n\t\t\t} else if (e.detail) {  //Firefox滑轮事件\n\t\t\t\tif (e.detail > 0) { //当滑轮向上滚动时\n\t\t\t\t\tthis.zoomImg(scale.range >= 100 ? 100 : ++scale.range);\n\t\t\t\t}\n\t\t\t\tif (e.detail < 0) {\n\t\t\t\t\tthis.zoomImg(scale.range <= 0 ? 0 : --scale.range);\n\t\t\t\t}\n\t\t\t}\n        },\n\t\t// 按钮按下开始放大\n\t\tstartZoomAdd(e) {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\tscale\n\t\t\t\t} = that;\n\t\t\tscale.zoomAddOn = true;\n\n\t\t\tfunction zoom() {\n\t\t\t\tif (scale.zoomAddOn) {\n\t\t\t\t\tlet range = scale.range >= 100 ? 100 : ++scale.range;\n\t\t\t\t\tthat.zoomImg(range);\n\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\tzoom();\n\t\t\t\t\t}, 60);\n\t\t\t\t}\n\t\t\t}\n\t\t\tzoom();\n\t\t},\n\t\t// 按钮松开或移开取消放大\n\t\tendZoomAdd(e) {\n\t\t\tthis.scale.zoomAddOn = false;\n\t\t},\n\t\t// 按钮按下开始缩小\n\t\tstartZoomSub(e) {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\tscale\n\t\t\t\t} = that;\n\t\t\tscale.zoomSubOn = true;\n\n\t\t\tfunction zoom() {\n\t\t\t\tif (scale.zoomSubOn) {\n\t\t\t\t\tlet range = scale.range <= 0 ? 0 : --scale.range;\n\t\t\t\t\tthat.zoomImg(range);\n\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\tzoom();\n\t\t\t\t\t}, 60);\n\t\t\t\t}\n\t\t\t}\n\t\t\tzoom();\n\t\t},\n\t\t// 按钮松开或移开取消缩小\n\t\tendZoomSub(e) {\n\t\t\tlet {\n\t\t\t\tscale\n\t\t\t} = this;\n\t\t\tscale.zoomSubOn = false;\n\t\t},\n\t\tzoomChange(e) {\n\t\t\tthis.zoomImg(e.target.value);\n\t\t},\n\t\t// 缩放原图\n\t\tzoomImg(newRange) {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\tsourceImgMasking,\n\t\t\t\t\tsourceImgMouseDown,\n\t\t\t\t\tscale\n\t\t\t\t} = this,\n\t\t\t\t{\n\t\t\t\t\tmaxWidth,\n\t\t\t\t\tmaxHeight,\n\t\t\t\t\tminWidth,\n\t\t\t\t\tminHeight,\n\t\t\t\t\twidth,\n\t\t\t\t\theight,\n\t\t\t\t\tx,\n\t\t\t\t\ty,\n\t\t\t\t\trange\n\t\t\t\t} = scale,\n\t\t\t\tsim = sourceImgMasking,\n\t\t\t\t// 蒙版宽高\n\t\t\t\tsWidth = sim.width,\n\t\t\t\tsHeight = sim.height,\n\t\t\t\t// 新宽高\n\t\t\t\tnWidth = minWidth + (maxWidth - minWidth) * newRange / 100,\n\t\t\t\tnHeight = minHeight + (maxHeight - minHeight) * newRange / 100,\n\t\t\t\t// 新坐标（根据蒙版中心点缩放）\n\t\t\t\tnX = sWidth / 2 - (nWidth / width) * (sWidth / 2 - x),\n\t\t\t\tnY = sHeight / 2 - (nHeight / height) * (sHeight / 2 - y);\n\n\t\t\t// 判断新坐标是否超过蒙版限制\n\t\t\tif (nX > 0) {\n\t\t\t\tnX = 0;\n\t\t\t}\n\t\t\tif (nY > 0) {\n\t\t\t\tnY = 0;\n\t\t\t}\n\t\t\tif (nX < sWidth - nWidth) {\n\t\t\t\tnX = sWidth - nWidth;\n\t\t\t}\n\t\t\tif (nY < sHeight - nHeight) {\n\t\t\t\tnY = sHeight - nHeight;\n\t\t\t}\n\n\t\t\t// 赋值处理\n\t\t\tscale.x = nX;\n\t\t\tscale.y = nY;\n\t\t\tscale.width = nWidth;\n\t\t\tscale.height = nHeight;\n\t\t\tscale.range = newRange;\n\t\t\tsetTimeout(function() {\n\t\t\t\tif (scale.range == newRange) {\n\t\t\t\t\tthat.createImg();\n\t\t\t\t}\n\t\t\t}, 300);\n\t\t},\n\t\t // 生成需求图片\n        createImg(e) {\n            let that = this,\n                {\n\t\t\t\t\timgFormat,\n\t\t\t\t\timgBgc,\n                    mime,\n                    sourceImg,\n                    scale: {\n                        x,\n                        y,\n                        width,\n                        height,\n                    },\n                    sourceImgMasking: {\n                        scale\n                    }\n                } = that,\n                canvas = that.$refs.canvas,\n                ctx = canvas.getContext('2d');\n            if (e) {\n                // 取消鼠标按下移动状态\n                that.sourceImgMouseDown.on = false;\n            }\n\t\t\tcanvas.width = that.width;\n            canvas.height = that.height;\n            ctx.clearRect(0, 0, that.width, that.height);\n\n\t\t\tif(imgFormat == 'png'){\n\t\t\t\tctx.fillStyle = 'rgba(0,0,0,0)';\n\t\t\t} else{\n\t\t\t\t// 如果jpg 为透明区域设置背景，默认白色\n\t\t\t\tctx.fillStyle = imgBgc;\n\t\t\t}\n\t\t\tctx.fillRect(0, 0, that.width, that.height);\n\n            ctx.drawImage(sourceImg, x / scale, y / scale, width / scale, height / scale);\n            that.createImgUrl = canvas.toDataURL(mime);\n        },\n\t\tprepareUpload(){\n\t\t\tlet {\n\t\t\t\turl,\n\t\t\t\tcreateImgUrl,\n\t\t\t\tfield,\n\t\t\t\tki\n\t\t\t} = this;\n\t\t\tthis.$emit('crop-success', createImgUrl, field, ki);\n\t\t\tif(typeof url == 'string' && url){\n\t\t\t\tthis.upload();\n\t\t\t}else{\n\t\t\t\tthis.off();\n\t\t\t}\n\t\t},\n\t\t// 上传图片\n\t\tupload() {\n\t\t\tlet that = this,\n\t\t\t\t{\n\t\t\t\t\tlang,\n\t\t\t\t\timgFormat,\n\t\t\t\t\tmime,\n\t\t\t\t\turl,\n\t\t\t\t\tparams,\n\t\t\t\t\theaders,\n\t\t\t\t\tfield,\n\t\t\t\t\tki,\n\t\t\t\t\tcreateImgUrl,\n\t\t\t\t\twithCredentials,\n\t\t\t\t\tmethod\n\t\t\t\t} = this,\n\t\t\t\tfmData = new FormData();\n\n\t\t\t// 添加其他参数\n\t\t\tif (typeof params == 'object' && params) {\n\t\t\t\tObject.keys(params).forEach((k) => {\n\t\t\t\t\tfmData.append(k, params[k]);\n\t\t\t\t})\n\t\t\t}\n\n\t\t\t// 将field的添加放到表单域的最后，以支持阿里云OSS的表单上传\n\t\t\tfmData.append(field, data2blob(createImgUrl, mime), field + '.' + imgFormat);\n\n\n\t\t\t// 监听进度回调\n\t\t\tconst uploadProgress = function(event) {\n\t\t\t\tif (event.lengthComputable) {\n\t\t\t\t\tthat.progress = 100 * Math.round(event.loaded) / event.total;\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// 上传文件\n\t\t\tthat.reset();\n\t\t\tthat.loading = 1;\n\t\t\tthat.setStep(3);\n\t\t\tnew Promise(function(resolve, reject) {\n\t\t\t\tlet client = new XMLHttpRequest();\n\t\t\t\tclient.open(method, url, true);\n\t\t\t\tclient.withCredentials = withCredentials;\n\t\t\t\tclient.onreadystatechange = function() {\n\t\t\t\t\tif (this.readyState !== 4) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (this.status === 200 || this.status === 201 || this.staus ===202 ) {\n\t\t\t\t\t\tresolve(JSON.parse(this.responseText));\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(this.status);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tclient.upload.addEventListener(\"progress\", uploadProgress, false); //监听进度\n\t\t\t\t// 设置header\n\t\t\t\tif (typeof headers == 'object' && headers) {\n\t\t\t\t\tObject.keys(headers).forEach((k) => {\n\t\t\t\t\t\tclient.setRequestHeader(k, headers[k]);\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\tclient.send(fmData);\n\t\t\t}).then(\n\t\t\t\t// 上传成功\n\t\t\t\tfunction(resData) {\n\t\t\t\t\tif (that.modelValue) {\n\t\t\t\t\t\tthat.loading = 2;\n\t\t\t\t\t\tthat.$emit('crop-upload-success', resData, field, ki);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t// 上传失败\n\t\t\t\tfunction(sts) {\n\t\t\t\t\tif (that.modelValue) {\n\t\t\t\t\t\tthat.loading = 3;\n\t\t\t\t\t\tthat.hasError = true;\n\t\t\t\t\t\tthat.errorMsg = lang.fail;\n\t\t\t\t\t\tthat.$emit('crop-upload-fail', sts, field, ki);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t},\n}\n\n</script>\n\n<!--\n<style lang='sass' src=\"./scss/upload.scss\">\n</style> -->\n\n<style>\n@import url('upload.css');\n</style>\n"]},"metadata":{},"sourceType":"module"}